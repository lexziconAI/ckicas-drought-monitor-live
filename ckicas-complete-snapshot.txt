PROJECT: CKICAS Drought Monitor
PURPOSE: Performance diagnosis for slow loading issue
DATE: 2025-11-21 08:57:46
PROJECT ROOT: C:\Users\regan\ID SYSTEM\ckicas-community-resilience

================================================================================
FILE: package.json
================================================================================
{
  "name": "ckicas-drought-monitor",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@google/genai": "^1.30.0",
    "@types/leaflet": "^1.9.21",
    "@types/react-router-dom": "^5.3.3",
    "leaflet": "^1.9.4",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "react-hook-form": "^7.66.1",
    "react-hot-toast": "^2.6.0",
    "react-leaflet": "^4.2.1",
    "react-router-dom": "^7.9.6",
    "recharts": "2.12.0"
  },
  "devDependencies": {
    "@types/node": "^22.14.0",
    "@vitejs/plugin-react": "^5.0.0",
    "typescript": "~5.8.2",
    "vite": "^6.2.0"
  }
}


================================================================================
FILE: vite.config.ts
================================================================================
import path from 'path';
import { defineConfig, loadEnv } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig(({ mode }) => {
    const env = loadEnv(mode, '.', '');
    return {
      server: {
        port: 3002,
        host: '0.0.0.0',
      },
      plugins: [react()],
      define: {
        'process.env.API_KEY': JSON.stringify(env.GEMINI_API_KEY),
        'process.env.GEMINI_API_KEY': JSON.stringify(env.GEMINI_API_KEY)
      },
      resolve: {
        alias: {
          '@': path.resolve(__dirname, '.'),
        }
      }
    };
});


================================================================================
FILE: tsconfig.json
================================================================================
{
  "compilerOptions": {
    "target": "ES2022",
    "experimentalDecorators": true,
    "useDefineForClassFields": false,
    "module": "ESNext",
    "lib": [
      "ES2022",
      "DOM",
      "DOM.Iterable"
    ],
    "skipLibCheck": true,
    "types": [
      "node"
    ],
    "moduleResolution": "bundler",
    "isolatedModules": true,
    "moduleDetection": "force",
    "allowJs": true,
    "jsx": "react-jsx",
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "allowImportingTsExtensions": true,
    "noEmit": true
  }
}

================================================================================
FILE: index.html
================================================================================
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CKICAS Drought Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="/index.css">
  </head>
  <body class="bg-slate-50 text-slate-900 antialiased">
    <div id="root"></div>
    <script type="module" src="/index.tsx"></script>
  </body>
</html>

================================================================================
FILE: index.tsx
================================================================================
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);

================================================================================
FILE: index.css
================================================================================
/* Fade-in-up animation for modals and panels */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fade-in-up {
  animation: fadeInUp 0.3s ease-out;
}

/* Custom scrollbar for chat */
.scrollbar-hide::-webkit-scrollbar {
  display: none;
}

.scrollbar-hide {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

/* Recharts Responsive Fix */
.recharts-wrapper {
  width: 100% !important;
}

/* Ensure Leaflet popups are always on top */
.leaflet-popup-high-z {
  z-index: 10000 !important;
}

/* Improve touch targets on mobile */
@media (max-width: 768px) {
  button, a {
    min-height: 44px;
    min-width: 44px;
  }
  
  input, textarea {
    font-size: 16px; /* Prevents iOS zoom on focus */
  }
}

/* Prevent map pan conflicts on mobile */
.leaflet-container {
  touch-action: pan-y;
}


================================================================================
FILE: App.tsx
================================================================================
import 'leaflet/dist/leaflet.css';
import React, { useState, useEffect, useRef } from 'react';
import { BrowserRouter as Router, Routes, Route, Link } from 'react-router-dom';
import { Toaster } from 'react-hot-toast';
import DroughtMap from './components/DroughtMap';
import ChatInterface from './components/ChatInterface';
import StatusCard from './components/StatusCard';
import HistoricalChart from './components/HistoricalChart';
import CouncilAlerts from './components/CouncilAlerts';
import NewsTicker from './components/NewsTicker';
import WeatherNarrative from './components/WeatherNarrative';
import QuickStats from './components/QuickStats';
import DataRefreshIndicator from './components/DataRefreshIndicator';
import RegionSearch, { RegionSearchRef } from './components/RegionSearch';
import ShortcutsHelpModal from './components/ShortcutsHelpModal';
import QuickStatsSkeleton from './components/QuickStatsSkeleton';
import WeatherMetricsSkeleton from './components/WeatherMetricsSkeleton';
import HistoricalChartSkeleton from './components/HistoricalChartSkeleton';
import Triggers from './pages/Triggers';
import SystemDynamics from './pages/SystemDynamics';
import TRCMap from './components/TRCMap';
import RainfallExplorer from './components/RainfallExplorer';
import { checkApiHealth, fetchDataSources, fetchForecastTrend, fetchHistoricalData, fetchDroughtRisk, evaluateTriggers } from './services/api';
import { DataSource, DroughtRiskData, HistoricalDataPoint } from './types';
import { NZ_REGIONS } from './constants';
import { toastNotifications } from './utils/toast';
import { useKeyboardShortcuts } from './hooks/useKeyboardShortcuts';

// Default user ID for trigger evaluation (TODO: Replace with actual authentication)
const DEFAULT_USER_ID = 1;

const Dashboard: React.FC = () => {
  const [apiStatus, setApiStatus] = useState<'online' | 'offline' | 'checking' | 'serverless'>('checking');
  const [latency, setLatency] = useState(0);
  const [dataSources, setDataSources] = useState<DataSource[]>([]);
  const [selectedRegionData, setSelectedRegionData] = useState<DroughtRiskData | null>(null);
  const [trendData, setTrendData] = useState<HistoricalDataPoint[]>([]);
  const [loadingTrend, setLoadingTrend] = useState(false);
  const [chartMode, setChartMode] = useState<'forecast' | 'history'>('forecast');
  const [chatTrigger, setChatTrigger] = useState<number>(0);
  const [allRegionsData, setAllRegionsData] = useState<DroughtRiskData[]>([]);
  const [lastDataUpdate, setLastDataUpdate] = useState<Date>(new Date());
  const [isRefreshing, setIsRefreshing] = useState(false);
  const [showShortcutsModal, setShowShortcutsModal] = useState(false);

  // Ref for RegionSearch component
  const regionSearchRef = useRef<RegionSearchRef>(null);

  // Helper function to extract weather data for trigger evaluation
  const extractWeatherData = (regionData: DroughtRiskData) => {
    return {
      temperature: regionData.factors.temperature_anomaly + 15.0, // Add baseline temp back
      rainfall: regionData.factors.rainfall_deficit,
      humidity: regionData.extended_metrics?.humidity || 0,
      wind_speed: regionData.extended_metrics?.wind_speed || 0
    };
  };

  // Helper function to evaluate triggers for current weather conditions
  const evaluateTriggersForRegions = async (regionsData: DroughtRiskData[]) => {
    if (regionsData.length === 0) return;

    // Use the first region's weather data as a representative sample
    // In a production app, you might want to evaluate for the user's specific region
    const weatherData = extractWeatherData(regionsData[0]);

    try {
      const evaluation = await evaluateTriggers(DEFAULT_USER_ID, weatherData);

      if (evaluation && evaluation.total_alerts > 0) {
        console.log(`[Trigger Evaluation] ${evaluation.total_alerts} alerts triggered at ${evaluation.evaluated_at}`);

        // Show toast notifications
        if (evaluation.total_alerts === 1) {
          const alert = evaluation.alerts[0];
          toastNotifications.triggerFired(alert.trigger.name, alert.trigger.region);
          console.log(`[Alert] ${alert.trigger.name} in ${alert.trigger.region}:`, alert.recommendations);
        } else {
          toastNotifications.multipleTriggersFired(evaluation.total_alerts);
          evaluation.alerts.forEach(alert => {
            console.log(`[Alert] ${alert.trigger.name} in ${alert.trigger.region}:`, alert.recommendations);
          });
        }
      } else if (evaluation) {
        console.log(`[Trigger Evaluation] No alerts triggered at ${evaluation.evaluated_at}`);
      }
    } catch (error) {
      console.error('[Trigger Evaluation] Failed to evaluate triggers:', error);
    }
  };

  useEffect(() => {
    const initSystem = async () => {
      setIsRefreshing(true);
      
      // Start fetches in parallel
      const healthPromise = checkApiHealth();
      const sourcesPromise = fetchDataSources().catch(e => { console.warn(e); return [] as DataSource[]; });
      
      // Progressive Loading Strategy:
      // We update regions in-place as they load, preventing the "wipe and reload" flash.
      
      const regionPromises = NZ_REGIONS.map(async (region) => {
        try {
          const data = await fetchDroughtRisk(region.lat, region.lon);
          setAllRegionsData(prev => {
            const index = prev.findIndex(p => p.region === data.region);
            if (index !== -1) {
              const newArr = [...prev];
              newArr[index] = data;
              return newArr;
            }
            return [...prev, data];
          });
          return data;
        } catch (e) {
          console.warn(`Failed to load ${region.name}`, e);
          return null;
        }
      });

      const health = await healthPromise;
      setApiStatus(health.status);
      setLatency(health.latency);

      if (health.status === 'online' || health.status === 'serverless') {
        try {
          const sources = await sourcesPromise;
          if (sources.length) setDataSources(sources);
          
          // Wait for all to complete to finish the refresh cycle
          const regionsData = (await Promise.all(regionPromises)).filter(Boolean) as DroughtRiskData[];
          
          setLastDataUpdate(new Date());
          
          // Evaluate triggers once we have data
          if (regionsData.length > 0) {
             await evaluateTriggersForRegions(regionsData);
          }
        } catch (e) {
          console.error("Failed to load sources", e);
        }
      }
      setIsRefreshing(false);
    };

    initSystem();
    const interval = setInterval(initSystem, 30000);
    return () => clearInterval(interval);
  }, []);

  const handleRegionSelect = async (data: DroughtRiskData) => {
    setSelectedRegionData(data);
    setLoadingTrend(true);
    setChartMode('forecast'); // Reset to forecast on new region select
    
    // Find the region definition to get lat/lon
    const regionDef = NZ_REGIONS.find(r => r.name === data.region);
    
    if (regionDef) {
      const trends = await fetchForecastTrend(regionDef.lat, regionDef.lon);
      setTrendData(trends);
    } else {
      console.warn(`Could not find coordinates for region: ${data.region}`);
      // Fallback to Wellington if not found, or handle error
      const trends = await fetchForecastTrend(-41.2866, 174.7756);
      setTrendData(trends);
    }
    setLoadingTrend(false);
  };

  const handleChartModeChange = async (mode: 'forecast' | 'history') => {
    if (!selectedRegionData) return;
    
    setChartMode(mode);
    setLoadingTrend(true);
    
    const regionDef = NZ_REGIONS.find(r => r.name === selectedRegionData.region);
    const lat = regionDef ? regionDef.lat : -41.2866;
    const lon = regionDef ? regionDef.lon : 174.7756;

    try {
      if (mode === 'history') {
        const history = await fetchHistoricalData(lat, lon, 90); // 3 months
        setTrendData(history);
      } else {
        const trends = await fetchForecastTrend(lat, lon);
        setTrendData(trends);
      }
    } catch (error) {
      console.error("Failed to switch chart data:", error);
      setTrendData([]);
    } finally {
      setLoadingTrend(false);
    }
  };

  const handleAnalyzeInChat = (data: DroughtRiskData) => {
    // Only trigger chat analysis, do NOT update chart or forecast data
    setChatTrigger(prev => prev + 1);
  };

  const handleManualRefresh = async () => {
    setIsRefreshing(true);
    
    // Start fetches in parallel
    const healthPromise = checkApiHealth();
    const sourcesPromise = fetchDataSources().catch(e => { console.warn(e); return [] as DataSource[]; });
    
    // Progressive loading for manual refresh too
    
    const regionPromises = NZ_REGIONS.map(async (region) => {
        try {
          const data = await fetchDroughtRisk(region.lat, region.lon);
          setAllRegionsData(prev => {
            const index = prev.findIndex(p => p.region === data.region);
            if (index !== -1) {
              const newArr = [...prev];
              newArr[index] = data;
              return newArr;
            }
            return [...prev, data];
          });
          return data;
        } catch (e) {
          console.warn(`Failed to load ${region.name}`, e);
          return null;
        }
    });

    const health = await healthPromise;
    setApiStatus(health.status);
    setLatency(health.latency);

    if (health.status === 'online' || health.status === 'serverless') {
      try {
        const sources = await sourcesPromise;
        if (sources.length) setDataSources(sources);
        
        const regionsData = (await Promise.all(regionPromises)).filter(Boolean) as DroughtRiskData[];
        
        if (regionsData.length) {
          setLastDataUpdate(new Date());
          // Evaluate triggers with current weather data
          await evaluateTriggersForRegions(regionsData);
        }

        // Show success toast
        toastNotifications.dataRefreshSuccess();
      } catch (e) {
        console.error("Failed to load sources", e);
        // Show error toast
        toastNotifications.dataRefreshError();
      }
    } else {
      // Show error toast if API is offline
      toastNotifications.dataRefreshError();
    }
    setIsRefreshing(false);
  };

  const handleRegionSearchSelect = async (region: { name: string; lat: number; lon: number; baseRisk: number }) => {
    setLoadingTrend(true);

    try {
      const data = await fetchDroughtRisk(region.lat, region.lon);
      setSelectedRegionData(data);

      const trends = await fetchForecastTrend(region.lat, region.lon);
      setTrendData(trends);

      // Show region loaded toast
      toastNotifications.regionLoaded(region.name);
    } catch (error) {
      console.error(`Failed to load data for ${region.name}:`, error);
    } finally {
      setLoadingTrend(false);
    }
  };

  // Keyboard shortcuts
  useKeyboardShortcuts({
    shortcuts: [
      {
        key: 'r',
        description: 'Refresh data',
        action: () => {
          if (!isRefreshing) {
            handleManualRefresh();
          }
        }
      },
      {
        key: '/',
        description: 'Focus search',
        action: () => {
          regionSearchRef.current?.focus();
        }
      },
      {
        key: 'Escape',
        description: 'Clear search',
        action: () => {
          regionSearchRef.current?.clear();
          setSelectedRegionData(null);
        },
        preventDefault: false
      },
      {
        key: '?',
        description: 'Show shortcuts',
        action: () => {
          setShowShortcutsModal(true);
        }
      }
    ]
  });

  const activeSourcesCount = dataSources.filter(s => s.status === 'active').length;

  // Calculate quick stats from all regions data
  const quickStats = {
    totalRegions: NZ_REGIONS.length,
    regionsInDrought: allRegionsData.filter(r => r.risk_score >= 50).length,
    highestRiskRegion: allRegionsData.length > 0
      ? allRegionsData.reduce((max, r) => r.risk_score > max.risk_score ? r : max, allRegionsData[0]).region
      : 'Loading...',
    nationalAverage: allRegionsData.length > 0
      ? Math.round(allRegionsData.reduce((sum, r) => sum + r.risk_score, 0) / allRegionsData.length)
      : 0
  };

  const getStatusBadge = () => {
    if (apiStatus === 'online') {
      return (
        <div className="flex items-center gap-2 px-3 py-1 bg-green-100 text-green-800 rounded-full">
          <div className="w-2 h-2 rounded-full bg-green-500"></div>
          <span className="font-medium text-xs">System Online ({latency}ms)</span>
        </div>
      );
    } else if (apiStatus === 'serverless') {
       return (
        <div className="flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-full">
          <div className="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></div>
          <span className="font-medium text-xs">Live (Serverless Mode)</span>
        </div>
      );
    } else if (apiStatus === 'checking') {
      return (
        <div className="flex items-center gap-2 px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full">
          <div className="w-2 h-2 rounded-full bg-yellow-500"></div>
          <span className="font-medium text-xs">Checking...</span>
        </div>
      );
    } else {
      return (
        <div className="flex items-center gap-2 px-3 py-1 bg-red-100 text-red-800 rounded-full">
          <div className="w-2 h-2 rounded-full bg-red-500"></div>
          <span className="font-medium text-xs">System Offline</span>
        </div>
      );
    }
  };

  return (
    <div className="min-h-screen flex flex-col bg-slate-50 font-sans">
      {/* Header */}
      <header className="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <img 
              src="/CKICAS_LOGO.png" 
              alt="CKICAS Logo" 
              className="h-14 w-auto object-contain" 
            />
            <h1 className="font-bold text-xl text-slate-900 tracking-tight">CKCIAS <span className="text-slate-500 font-normal">Drought Monitor</span></h1>
          </div>
          <div className="flex items-center gap-4 text-sm">
            <Link
              to="/triggers"
              className="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors"
            >
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
              </svg>
              <span className="hidden sm:inline">Alert Triggers</span>
            </Link>
            <Link
              to="/trc-data"
              className="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors"
            >
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
              </svg>
              <span className="hidden sm:inline">TRC Sites</span>
            </Link>
            <Link
              to="/rainfall-explorer"
              className="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors"
            >
              <span className="text-lg leading-none">üåßÔ∏è</span>
              <span className="hidden sm:inline">Rainfall Sim</span>
            </Link>
            <Link
              to="/system-dynamics"
              className="flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors"
            >
              <span className="text-lg leading-none">üåÄ</span>
              <span className="hidden sm:inline">System Dynamics</span>
            </Link>
            <button
              onClick={() => setShowShortcutsModal(true)}
              className="flex items-center gap-1.5 px-3 py-1.5 text-xs text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors group"
              title="View keyboard shortcuts"
            >
              <svg className="w-4 h-4 text-slate-400 group-hover:text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
              </svg>
              <span className="hidden sm:inline">Keyboard shortcuts: Press</span>
              <kbd className="px-1.5 py-0.5 text-xs font-semibold text-slate-700 bg-slate-100 border border-slate-300 rounded shadow-sm group-hover:bg-white">?</kbd>
            </button>
            <DataRefreshIndicator
              lastUpdated={lastDataUpdate}
              onRefresh={handleManualRefresh}
              isRefreshing={isRefreshing}
            />
            {getStatusBadge()}
          </div>
        </div>
        <CouncilAlerts />
        <NewsTicker />
        <WeatherNarrative />
      </header>

      <main className="flex-1 max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8 space-y-6">
        {/* Quick Stats Summary */}
        {allRegionsData.length === 0 ? (
          <QuickStatsSkeleton />
        ) : (
          <QuickStats
            totalRegions={quickStats.totalRegions}
            regionsInDrought={quickStats.regionsInDrought}
            highestRiskRegion={quickStats.highestRiskRegion}
            nationalAverage={quickStats.nationalAverage}
          />
        )}

        {/* Region Search */}
        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
          <div className="flex items-center justify-between mb-3">
            <h3 className="text-sm font-semibold text-slate-700">Find Region</h3>
          </div>
          <RegionSearch ref={regionSearchRef} regions={NZ_REGIONS} onRegionSelect={handleRegionSearchSelect} />
        </div>

        {/* Stats Grid */}
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <StatusCard
            title="Active Sensors"
            value={activeSourcesCount}
            subtitle={`Total Sources: ${dataSources.length}`}
            status={activeSourcesCount > 0 ? 'success' : 'warning'}
            icon={<svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>}
          />
          <StatusCard
            title="Nat'l Avg Risk"
            value="42/100"
            subtitle="Moderate Concern"
            status="warning"
            icon={<svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>}
          />
          <StatusCard
            title="AI Model"
            value="Claude Haiku 4.5"
            subtitle="Anthropic"
            status="success"
            icon={<svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>}
          />
          <StatusCard
            title="Last Update"
            value="Just now"
            subtitle="Real-time Sync"
            status="neutral"
            icon={<svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>}
          />
        </div>

        {/* Main Interface: Map and Chat */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="lg:col-span-2 flex flex-col gap-6">
            <div className="bg-white p-1 rounded-xl shadow-sm border border-slate-200 relative z-0">
               <DroughtMap 
                 regionsData={allRegionsData}
                 onRegionSelect={handleRegionSelect} 
                 onAnalyzeInChat={handleAnalyzeInChat} 
               />
            </div>

            {/* Detailed Region Panel (Visible on Selection) */}
            {selectedRegionData && (
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-fade-in-up relative z-10">
                {/* Extended Metrics */}
                {loadingTrend ? (
                  <WeatherMetricsSkeleton />
                ) : (
                  <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 className="font-bold text-lg text-slate-800 mb-4 flex items-center justify-between">
                      <span>Weather Metrics: {selectedRegionData.region}</span>
                      <span className="text-xs font-normal px-2 py-1 bg-slate-100 rounded text-slate-500">{selectedRegionData.extended_metrics?.weather_main || 'Clear'}</span>
                    </h3>
                    <div className="grid grid-cols-2 gap-4">
                      <div className="p-3 bg-slate-50 rounded-lg">
                        <div className="text-xs text-slate-500 mb-1">Wind Speed</div>
                        <div className="text-xl font-bold text-slate-700">{selectedRegionData.extended_metrics?.wind_speed || '--'} <span className="text-xs font-normal">m/s</span></div>
                      </div>
                      <div className="p-3 bg-slate-50 rounded-lg">
                        <div className="text-xs text-slate-500 mb-1">Humidity</div>
                        <div className="text-xl font-bold text-blue-600">{selectedRegionData.extended_metrics?.humidity || '--'} <span className="text-xs font-normal">%</span></div>
                      </div>
                      <div className="p-3 bg-slate-50 rounded-lg">
                        <div className="text-xs text-slate-500 mb-1">Pressure</div>
                        <div className="text-xl font-bold text-slate-700">{selectedRegionData.extended_metrics?.pressure || '--'} <span className="text-xs font-normal">hPa</span></div>
                      </div>
                       <div className="p-3 bg-slate-50 rounded-lg">
                        <div className="text-xs text-slate-500 mb-1">Soil Deficit</div>
                        <div className="text-xl font-bold text-orange-600">{selectedRegionData.factors.rainfall_deficit} <span className="text-xs font-normal">mm</span></div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Historical Graph */}
                <div className="h-[250px] relative">
                  {/* Chart Controls */}
                  <div className="absolute top-4 right-4 z-10 flex bg-slate-100 rounded-lg p-1 border border-slate-200">
                    <button
                      onClick={() => handleChartModeChange('forecast')}
                      className={`px-3 py-1 text-xs font-medium rounded-md transition-all ${
                        chartMode === 'forecast' 
                          ? 'bg-white text-blue-600 shadow-sm' 
                          : 'text-slate-500 hover:text-slate-700'
                      }`}
                    >
                      7-Day Forecast
                    </button>
                    <button
                      onClick={() => handleChartModeChange('history')}
                      className={`px-3 py-1 text-xs font-medium rounded-md transition-all ${
                        chartMode === 'history' 
                          ? 'bg-white text-blue-600 shadow-sm' 
                          : 'text-slate-500 hover:text-slate-700'
                      }`}
                    >
                      3-Month History
                    </button>
                  </div>

                  {loadingTrend ? (
                    <HistoricalChartSkeleton />
                  ) : (
                    <HistoricalChart 
                      data={trendData} 
                      regionName={selectedRegionData.region} 
                      title={chartMode === 'history' ? '3-Month Historical Data' : '7-Day Forecast Trend'}
                    />
                  )}
                </div>
              </div>
            )}
          </div>

          <div className="lg:col-span-1 relative z-10">
            <ChatInterface
              selectedRegion={selectedRegionData?.region || null}
              selectedRegionData={selectedRegionData}
              trigger={chatTrigger}
            />
          </div>
        </div>
      </main>

      <footer className="bg-white border-t border-slate-200 py-6 mt-8">
        <div className="max-w-7xl mx-auto px-4 text-center text-slate-500 text-sm">
          <p>&copy; 2025 CKCIAS Drought Monitor. A Caring 4 WhƒÅnau Initiative.</p>
          <p className="mt-1">Fractal Army Deployment ‚Ä¢ Claude Haiku 4.5 Integrated ‚Ä¢ OpenWeather Forecasts</p>
        </div>
      </footer>

      {/* Keyboard Shortcuts Help Modal */}
      <ShortcutsHelpModal
        isOpen={showShortcutsModal}
        onClose={() => setShowShortcutsModal(false)}
      />
    </div>
  );
};

const App: React.FC = () => {
  return (
    <Router>
      <Toaster position="top-right" />
      <Routes>
        <Route path="/" element={<Dashboard />} />
        <Route path="/triggers" element={<Triggers />} />
        <Route path="/system-dynamics" element={<SystemDynamics />} />
        <Route path="/trc-data" element={<TRCMap />} />
        <Route path="/rainfall-explorer" element={
          <div className="min-h-screen bg-slate-50">
            <header className="bg-white border-b border-slate-200 shadow-sm">
              <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <Link to="/" className="flex items-center gap-2 hover:opacity-80 transition-opacity">
                    <img src="/CKICAS_LOGO.png" alt="CKICAS Logo" className="h-10 w-auto" />
                    <span className="font-bold text-xl text-slate-900">CKCIAS <span className="text-slate-500 font-normal">Drought Monitor</span></span>
                  </Link>
                </div>
                <Link to="/" className="text-sm font-medium text-slate-600 hover:text-slate-900">‚Üê Back to Dashboard</Link>
              </div>
            </header>
            <main className="max-w-7xl mx-auto px-4 py-8">
              <RainfallExplorer />
            </main>
          </div>
        } />
      </Routes>
    </Router>
  );
};

export default App;


================================================================================
FILE: constants.ts
================================================================================
import { Region } from './types';

export const API_BASE_URL = 'http://localhost:9101';

// FALLBACK KEYS (Used when backend is offline)
export const GOOGLE_API_KEY = 'AIzaSyCFe1c5oJi9D8gSm5b8InhvoIydmdDj9NE';
export const OPENWEATHER_API_KEY = 'd7ab6944b5791f6c502a506a6049165f';

export const NZ_REGIONS: Region[] = [
  { name: 'Northland', lat: -35.7, lon: 174.3, baseRisk: 25 },
  { name: 'Auckland', lat: -36.8, lon: 174.7, baseRisk: 15 },
  { name: 'Waikato', lat: -37.7, lon: 175.2, baseRisk: 55 },
  { name: 'Bay of Plenty', lat: -37.7, lon: 176.2, baseRisk: 45 },
  { name: 'Gisborne', lat: -38.6, lon: 178.0, baseRisk: 62 },
  { name: "Hawke's Bay", lat: -39.5, lon: 176.8, baseRisk: 58 },
  { name: 'Taranaki', lat: -39.1, lon: 174.1, baseRisk: 38 },
  { name: 'Manawatu-Wanganui', lat: -40.0, lon: 175.7, baseRisk: 42 },
  { name: 'Wellington', lat: -41.3, lon: 174.8, baseRisk: 28 },
  { name: 'Tasman', lat: -41.3, lon: 173.0, baseRisk: 35 },
  { name: 'Nelson', lat: -41.3, lon: 173.3, baseRisk: 32 },
  { name: 'Marlborough', lat: -41.5, lon: 173.9, baseRisk: 48 },
  { name: 'West Coast', lat: -42.4, lon: 171.2, baseRisk: 20 },
  { name: 'Canterbury', lat: -43.5, lon: 171.2, baseRisk: 65 },
  { name: 'Otago', lat: -45.0, lon: 170.5, baseRisk: 55 },
  { name: 'Southland', lat: -46.4, lon: 168.4, baseRisk: 35 }
];

export const RISK_COLORS = {
  Low: '#22c55e', // green-500
  Medium: '#eab308', // yellow-500
  High: '#f97316', // orange-500
  Critical: '#ef4444', // red-500
};

================================================================================
FILE: types.ts
================================================================================
export interface Region {
  name: string;
  lat: number;
  lon: number;
  baseRisk: number;
}

export interface DroughtRiskData {
  region: string;
  risk_score: number;
  risk_level: 'Low' | 'Medium' | 'High' | 'Critical';
  factors: {
    rainfall_deficit: number;
    soil_moisture_index: number;
    temperature_anomaly: number;
  };
  extended_metrics?: {
    wind_speed: number;
    humidity: number;
    pressure: number;
    uv_index?: number;
    weather_main?: string;
  };
  data_source: string;
  last_updated: string;
}

export interface HistoricalDataPoint {
  date: string;
  risk_score: number;
  soil_moisture: number;
  temp: number;
  rain_probability: number;
}

export interface RssFeedItem {
  title: string;
  link: string;
  source: string;
  published: string;
  summary?: string;
}

export interface ChatMessage {
  role: 'user' | 'assistant';
  content: string;
  timestamp: number;
}

export interface ApiStatus {
  status: 'online' | 'offline' | 'checking';
  latency_ms: number;
}

export interface DataSource {
  name: string;
  status: 'active' | 'inactive';
  last_sync: string;
}

// User and Trigger Management Types
export interface User {
  id: string;
  name: string;
  email: string;
  organization: string;
  region: string;
}

export type TriggerIndicator = 'temp' | 'rainfall' | 'humidity' | 'wind_speed';
export type TriggerOperator = '>' | '<' | '>=' | '<=' | '==';
export type CombinationRule = 'any_1' | 'any_2' | 'any_3' | 'all';

export interface TriggerCondition {
  indicator: TriggerIndicator;
  operator: TriggerOperator;
  threshold: number;
}

export interface Trigger {
  id: string;
  user_id: string;
  name: string;
  region: string;
  conditions: TriggerCondition[];
  combination_rule: CombinationRule;
  is_active: boolean;
  created_at: string;
  updated_at: string;
}

export interface CreateTriggerRequest {
  user_id: string;
  name: string;
  region: string;
  conditions: TriggerCondition[];
  combination_rule: CombinationRule;
  is_active?: boolean;
}

export interface UpdateTriggerRequest {
  name?: string;
  region?: string;
  conditions?: TriggerCondition[];
  combination_rule?: CombinationRule;
  is_active?: boolean;
}

export interface TriggerFormData {
  name: string;
  region: string;
  conditions: TriggerCondition[];
  combination_rule: CombinationRule;
  is_active: boolean;
}

================================================================================
FILE: services/api.ts
================================================================================
import { NZ_REGIONS, API_BASE_URL, OPENWEATHER_API_KEY } from '../constants';
import { DroughtRiskData, DataSource, HistoricalDataPoint, RssFeedItem } from '../types';

// Helper to suppress connection errors in console but log real issues
const safeFetch = async (url: string, options?: RequestInit) => {
  try {
    const res = await fetch(url, options);
    if (!res.ok) {
      throw new Error(`HTTP_${res.status}`);
    }
    return res;
  } catch (error) {
    const msg = (error as Error).message;
    if (msg.startsWith('HTTP_')) {
      throw error; 
    }
    throw new Error('CONNECTION_REFUSED');
  }
};

export const checkApiHealth = async (): Promise<{ status: 'online' | 'offline' | 'serverless', latency: number }> => {
  const start = Date.now();
  try {
    await safeFetch(`${API_BASE_URL}/health`, { method: 'GET' });
    return { status: 'online', latency: Date.now() - start };
  } catch (e) {
    if (OPENWEATHER_API_KEY) {
      return { status: 'serverless', latency: 0 };
    }
    return { status: 'offline', latency: 0 };
  }
};

export const fetchDroughtRisk = async (lat: number, lon: number): Promise<DroughtRiskData> => {
  const region = NZ_REGIONS.find(r => 
    Math.abs(r.lat - lat) < 0.1 && Math.abs(r.lon - lon) < 0.1
  ) || { name: "Unknown Region", lat: 0, lon: 0, baseRisk: 30 };

  try {
    const res = await safeFetch(`${API_BASE_URL}/api/public/drought-risk?lat=${lat}&lon=${lon}&region=${encodeURIComponent(region.name)}`);
    return await res.json();
  } catch (error) {
    // Failover: Client-Side OpenWeatherMap Call
    try {
       const weatherRes = await fetch(
        `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}&units=metric`
      );
      
      if (weatherRes.ok) {
        const weatherData = await weatherRes.json();
        const currentTemp = weatherData.main.temp;
        const humidity = weatherData.main.humidity;
        
        const baselineTemp = 15.0;
        const tempAnomaly = currentTemp - baselineTemp;
        const humidityDeficit = Math.max(0, 80 - humidity);
        
        let baseRisk = region.baseRisk;
        let riskScore = baseRisk + (tempAnomaly * 2.0) + (humidityDeficit * 0.5);
        riskScore = Math.min(99, Math.max(5, Math.floor(riskScore)));

        let riskLevel: 'Low' | 'Medium' | 'High' | 'Critical' = 'Low';
        if (riskScore > 75) riskLevel = 'Critical';
        else if (riskScore > 50) riskLevel = 'High';
        else if (riskScore > 25) riskLevel = 'Medium';

        return {
          region: region.name,
          risk_score: riskScore,
          risk_level: riskLevel,
          factors: {
            rainfall_deficit: humidityDeficit,
            soil_moisture_index: 100 - riskScore,
            temperature_anomaly: parseFloat(tempAnomaly.toFixed(1))
          },
          extended_metrics: {
            wind_speed: weatherData.wind.speed,
            humidity: humidity,
            pressure: weatherData.main.pressure,
            weather_main: weatherData.weather[0].main
          },
          data_source: 'OpenWeatherMap (Live Client)',
          last_updated: new Date().toISOString()
        };
      } else {
        throw new Error("OpenWeatherMap API failed");
      }
    } catch (owError) {
      throw new Error("DATA_UNAVAILABLE");
    }
  }
};

export const fetchForecastTrend = async (lat: number, lon: number): Promise<HistoricalDataPoint[]> => {
  try {
    const res = await safeFetch(`${API_BASE_URL}/api/public/forecast-trend?lat=${lat}&lon=${lon}`);
    return await res.json();
  } catch (e) {
    // No Mock Data - Return Empty Array to signal UI to show "No Data" state
    console.error("Forecast fetch failed:", e);
    return [];
  }
};

export const fetchHistoricalData = async (lat: number, lon: number, days: number = 90): Promise<HistoricalDataPoint[]> => {
  try {
    const res = await safeFetch(`${API_BASE_URL}/api/public/history?lat=${lat}&lon=${lon}&days=${days}`);
    return await res.json();
  } catch (e) {
    console.error("History fetch failed:", e);
    return [];
  }
};

export const fetchCouncilAlerts = async (): Promise<RssFeedItem[]> => {
  try {
    const res = await safeFetch(`${API_BASE_URL}/api/public/council-alerts`);
    return await res.json();
  } catch (e) {
    return [
      {
        title: "System: Connect Backend for Live Council Feeds",
        link: "#",
        source: "System",
        published: "Now",
        summary: "To see real council RSS feeds, please ensure the Python backend is running."
      }
    ];
  }
};

export const fetchNewsHeadlines = async (): Promise<RssFeedItem[]> => {
  try {
    const res = await safeFetch(`${API_BASE_URL}/api/public/news-headlines`);
    return await res.json();
  } catch (e) {
    return [
      {
        title: "System: Connect Backend for Live News Feeds",
        link: "#",
        source: "System",
        published: new Date().toISOString(),
        summary: "To see real news feeds, please ensure the Python backend is running."
      }
    ];
  }
};

export const fetchDataSources = async (): Promise<DataSource[]> => {
  try {
    const res = await safeFetch(`${API_BASE_URL}/api/public/data-sources`);
    return await res.json();
  } catch (e) {
    return [
      { name: 'NIWA DataHub', status: 'inactive', last_sync: 'Backend Offline' },
      { name: 'OpenWeatherMap', status: OPENWEATHER_API_KEY ? 'active' : 'inactive', last_sync: OPENWEATHER_API_KEY ? 'Live (Client-Side)' : 'Missing Key' },
      { name: 'Regional Councils', status: 'inactive', last_sync: 'Backend Offline' }
    ];
  }
};

export const sendChatMessage = async (message: string): Promise<string> => {
  try {
    const res = await safeFetch(`${API_BASE_URL}/api/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message })
    });
    const data = await res.json();
    return data.response;
  } catch (error) {
    // Claude Haiku 4.5 is our primary chat backend - no fallback
    console.error('Chat backend connection failed:', error);
    return "Cannot connect to Claude Haiku 4.5 backend. Please ensure the backend server is running on port 9101.";
  }
};

export const evaluateTriggers = async (userId: number, weatherData: any): Promise<any> => {
  try {
    const res = await safeFetch(`${API_BASE_URL}/api/triggers/evaluate`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ user_id: userId, weather_data: weatherData })
    });
    return await res.json();
  } catch (e) {
    console.warn("Trigger evaluation failed (backend offline?)", e);
    return null;
  }
};


================================================================================
FILE: components/DroughtMap.tsx
================================================================================
import React, { useEffect, useState } from 'react';
import { MapContainer, TileLayer, CircleMarker, Popup, useMap } from 'react-leaflet';
import { NZ_REGIONS, RISK_COLORS } from '../constants';
import { fetchDroughtRisk } from '../services/api';
import { DroughtRiskData } from '../types';

// Leaflet CSS is loaded in index.html

interface DroughtMapProps {
  regionsData: DroughtRiskData[];
  onRegionSelect: (data: DroughtRiskData) => void;
  onAnalyzeInChat: (data: DroughtRiskData) => void;
}

const MapController = () => {
  const map = useMap();
  // Force map invalidation to fix rendering issues in some layouts
  useEffect(() => {
    setTimeout(() => {
      map.invalidateSize();
    }, 100);
  }, [map]);
  return null;
};

const DroughtMap: React.FC<DroughtMapProps> = ({ regionsData, onRegionSelect, onAnalyzeInChat }) => {
  const [loading, setLoading] = useState<boolean>(false);

  // Convert array to map for easier lookup
  const regionDataMap = React.useMemo(() => {
    const map: Record<string, DroughtRiskData> = {};
    regionsData.forEach(d => {
      map[d.region] = d;
    });
    return map;
  }, [regionsData]);

  const getRiskColor = (level: string) => {
    return RISK_COLORS[level as keyof typeof RISK_COLORS] || '#94a3b8';
  };

  // Lock map to NZ bounds
  const nzBounds: [[number, number], [number, number]] = [
    [-47.5, 165.0],  // Southwest
    [-33.5, 180.0]   // Northeast
  ];

  return (
    <div className="h-[400px] sm:h-[500px] lg:h-[600px] w-full rounded-xl overflow-hidden border border-slate-200 shadow-md relative bg-slate-100 z-0">
      {/* Loading overlay only if no data at all */}
      {regionsData.length === 0 && (
        <div className="absolute inset-0 z-[1000] flex items-center justify-center bg-white/80 backdrop-blur-sm">
          <div className="flex flex-col items-center space-y-2">
            <div className="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <span className="text-sm font-medium text-slate-600">Scanning Regions...</span>
          </div>
        </div>
      )}
      
      <MapContainer 
        center={[-41.2, 174.8]} 
        zoom={5} 
        minZoom={5}
        maxBounds={nzBounds}
        maxBoundsViscosity={1.0}
        scrollWheelZoom={false} 
        style={{ height: '100%', width: '100%' }}
      >
        <MapController />
        <TileLayer
          attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
        />
        
        {NZ_REGIONS.map((region) => {
          const riskData = regionDataMap[region.name];
          const color = riskData ? getRiskColor(riskData.risk_level) : '#cbd5e1';
          
          return (
            <CircleMarker
              key={region.name}
              center={[region.lat, region.lon]}
              pathOptions={{ 
                color: color, 
                fillColor: color, 
                fillOpacity: 0.6, 
                weight: 2 
              }}
              radius={20}
              eventHandlers={{
                click: () => {
                  if (riskData) onRegionSelect(riskData);
                },
              }}
            >
              <Popup>
                <div className="p-2 min-w-[200px]">
                  <h3 className="font-bold text-lg mb-1">{region.name}</h3>
                  {riskData ? (
                    <div className="space-y-2">
                      <div className="flex justify-between items-center">
                        <span className="text-sm text-slate-500">Risk Score:</span>
                        <span className="font-mono font-bold text-lg" style={{color}}>{riskData.risk_score}</span>
                      </div>
                      <div className="text-xs text-slate-500 border-t pt-2 mt-1">
                        <div>Rainfall Deficit: {riskData.factors.rainfall_deficit} mm</div>
                        <div>Soil Moisture: {riskData.factors.soil_moisture_index}</div>
                      </div>
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          onAnalyzeInChat(riskData);
                        }}
                        className="w-full mt-2 text-xs bg-slate-100 hover:bg-slate-200 py-1 rounded text-slate-700 transition-colors"
                      >
                        Analyze in Chat
                      </button>
                    </div>
                  ) : (
                    <span>Loading data...</span>
                  )}
                </div>
              </Popup>
            </CircleMarker>
          );
        })}
      </MapContainer>
    </div>
  );
};

export default DroughtMap;

================================================================================
FILE: components/ChatInterface.tsx
================================================================================
import React, { useState, useRef, useEffect } from 'react';
import { ChatMessage, DroughtRiskData } from '../types';
import { sendChatMessage, fetchDroughtRisk } from '../services/api';
import { NZ_REGIONS } from '../constants';

interface ChatInterfaceProps {
  selectedRegion: string | null;
  selectedRegionData: DroughtRiskData | null;
  trigger?: number;
}

const ChatInterface: React.FC<ChatInterfaceProps> = ({ selectedRegion, selectedRegionData, trigger = 0 }) => {
  const [messages, setMessages] = useState<ChatMessage[]>([
    {
      role: 'assistant',
      content: 'Kia ora! I am your CKCIAS drought monitoring assistant. Ask me about drought risks in any NZ region or select a region on the map.',
      timestamp: Date.now(),
    }
  ]);
  const [input, setInput] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  useEffect(() => {
    if (selectedRegion && selectedRegionData && trigger > 0) {
      // Build a data-rich prompt with actual metrics
      const prompt = `Analyze the current drought situation for ${selectedRegion} based on this real-time data:

Region: ${selectedRegionData.region}
Risk Level: ${selectedRegionData.risk_level}
Risk Score: ${selectedRegionData.risk_score}/10

Current Metrics:
- Temperature: ${selectedRegionData.factors.temperature || 'N/A'}¬∞C (Anomaly: ${selectedRegionData.factors.temperature_anomaly || 'N/A'}¬∞C)
- Humidity: ${selectedRegionData.extended_metrics?.humidity || selectedRegionData.factors.humidity || 'N/A'}%
- Rainfall (24h forecast): ${selectedRegionData.factors.rainfall_24h || 'N/A'}mm
- Rainfall Deficit: ${selectedRegionData.factors.rainfall_deficit || 'N/A'}mm
- Soil Moisture Index: ${selectedRegionData.factors.soil_moisture_index || 'N/A'}
- Wind Speed: ${selectedRegionData.extended_metrics?.wind_speed || 'N/A'} m/s
- Pressure: ${selectedRegionData.extended_metrics?.pressure || 'N/A'} hPa
- Weather: ${selectedRegionData.extended_metrics?.weather_main || selectedRegionData.weather_description || 'N/A'}

Data Source: ${selectedRegionData.data_source || 'OpenWeather'}
Last Updated: ${selectedRegionData.last_updated || selectedRegionData.timestamp}

Please provide a concise analysis of the drought risk, what the data indicates, and any recommendations for this region.`;

      handleSend(prompt);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [trigger]);

  const handleSend = async (text: string = input) => {
    if (!text.trim() || isTyping) return;

    const userMsg: ChatMessage = {
      role: 'user',
      content: text,
      timestamp: Date.now(),
    };

    setMessages(prev => [...prev, userMsg]);
    setInput('');
    setIsTyping(true);

    try {
      // Detect if the user is asking about a specific region
      const detectedRegion = NZ_REGIONS.find(region =>
        text.toLowerCase().includes(region.name.toLowerCase())
      );

      console.log('üîç Region detection:', {
        userText: text,
        detectedRegion: detectedRegion?.name || 'None',
        selectedRegionData: selectedRegionData?.region || 'None'
      });

      let enrichedPrompt = text;

      // If a region is mentioned and we don't have its data already, fetch it
      if (detectedRegion && (!selectedRegionData || selectedRegionData.region !== detectedRegion.name)) {
        try {
          console.log('üì° Fetching data for:', detectedRegion.name);
          const regionData = await fetchDroughtRisk(detectedRegion.lat, detectedRegion.lon);
          console.log('‚úÖ Data fetched:', regionData);

          // Enrich the prompt with real-time data
          enrichedPrompt = `${text}

Here is the current real-time data for ${regionData.region}:

Risk Level: ${regionData.risk_level}
Risk Score: ${regionData.risk_score}/10

Current Metrics:
- Temperature: ${regionData.factors.temperature || 'N/A'}¬∞C (Anomaly: ${regionData.factors.temperature_anomaly || 'N/A'}¬∞C)
- Humidity: ${regionData.extended_metrics?.humidity || regionData.factors.humidity || 'N/A'}%
- Rainfall (24h forecast): ${regionData.factors.rainfall_24h || 'N/A'}mm
- Rainfall Deficit: ${regionData.factors.rainfall_deficit || 'N/A'}mm
- Soil Moisture Index: ${regionData.factors.soil_moisture_index || 'N/A'}
- Wind Speed: ${regionData.extended_metrics?.wind_speed || 'N/A'} m/s
- Pressure: ${regionData.extended_metrics?.pressure || 'N/A'} hPa
- Weather: ${regionData.extended_metrics?.weather_main || regionData.weather_description || 'N/A'}

Data Source: ${regionData.data_source || 'OpenWeather'}
Last Updated: ${regionData.last_updated || regionData.timestamp}

Please analyze this data and provide a detailed response to the user's question.`;
        } catch (fetchError) {
          console.error('Error fetching region data:', fetchError);
          // Continue with original prompt if fetch fails
        }
      } else if (selectedRegionData && text.toLowerCase().includes(selectedRegionData.region.toLowerCase())) {
        // Use already selected region data
        enrichedPrompt = `${text}

Here is the current real-time data for ${selectedRegionData.region}:

Risk Level: ${selectedRegionData.risk_level}
Risk Score: ${selectedRegionData.risk_score}/10

Current Metrics:
- Temperature: ${selectedRegionData.factors.temperature || 'N/A'}¬∞C (Anomaly: ${selectedRegionData.factors.temperature_anomaly || 'N/A'}¬∞C)
- Humidity: ${selectedRegionData.extended_metrics?.humidity || selectedRegionData.factors.humidity || 'N/A'}%
- Rainfall (24h forecast): ${selectedRegionData.factors.rainfall_24h || 'N/A'}mm
- Rainfall Deficit: ${selectedRegionData.factors.rainfall_deficit || 'N/A'}mm
- Soil Moisture Index: ${selectedRegionData.factors.soil_moisture_index || 'N/A'}
- Wind Speed: ${selectedRegionData.extended_metrics?.wind_speed || 'N/A'} m/s
- Pressure: ${selectedRegionData.extended_metrics?.pressure || 'N/A'} hPa
- Weather: ${selectedRegionData.extended_metrics?.weather_main || selectedRegionData.weather_description || 'N/A'}

Data Source: ${selectedRegionData.data_source || 'OpenWeather'}
Last Updated: ${selectedRegionData.last_updated || selectedRegionData.timestamp}

Please analyze this data and provide a detailed response to the user's question.`;
      }

      console.log('üì§ Sending prompt to backend:', enrichedPrompt.substring(0, 200) + '...');
      const responseText = await sendChatMessage(enrichedPrompt);
      console.log('üì• Received response:', responseText.substring(0, 200) + '...');
      const botMsg: ChatMessage = {
        role: 'assistant',
        content: responseText,
        timestamp: Date.now(),
      };
      setMessages(prev => [...prev, botMsg]);
    } catch (error) {
      const errorMsg: ChatMessage = {
        role: 'assistant',
        content: "Sorry, I'm having trouble connecting to the drought analysis engine. Please ensure the backend is running on port 9100.",
        timestamp: Date.now(),
      };
      setMessages(prev => [...prev, errorMsg]);
    } finally {
      setIsTyping(false);
    }
  };

  // Helper to render simple Markdown (Bold and Lists)
  const renderMessageContent = (text: string) => {
    const lines = text.split('\n');
    return lines.map((line, i) => {
      // Check for bullet points
      const isBullet = line.trim().startsWith('* ') || line.trim().startsWith('- ');
      const cleanLine = isBullet ? line.trim().substring(2) : line;

      // Parse bold syntax (**text**)
      const parts = cleanLine.split(/(\*\*.*?\*\*)/g);
      const formattedLine = parts.map((part, j) => {
        if (part.startsWith('**') && part.endsWith('**')) {
          return <strong key={j} className="font-bold text-slate-900">{part.slice(2, -2)}</strong>;
        }
        return <span key={j}>{part}</span>;
      });

      if (isBullet) {
        return (
          <div key={i} className="flex items-start gap-2 ml-3 mt-1 mb-1">
            <span className="text-slate-400 mt-1.5 text-[10px]">‚Ä¢</span>
            <div className="flex-1 leading-relaxed">{formattedLine}</div>
          </div>
        );
      }

      // Standard paragraph (only add margin if it's not the first line)
      return (
        <p key={i} className={`leading-relaxed ${i > 0 ? 'mt-2' : ''}`}>
          {formattedLine}
        </p>
      );
    });
  };

  return (
    <div className="flex flex-col h-[600px] bg-white rounded-xl border border-slate-200 shadow-md overflow-hidden">
      <div className="bg-slate-800 text-white p-4 flex justify-between items-center">
        <div>
          <h2 className="font-bold text-lg">Drought Assistant</h2>
          <p className="text-xs text-slate-400">Powered by Claude Haiku 4.5</p>
        </div>
        <div className={`w-2 h-2 rounded-full ${isTyping ? 'bg-green-400 animate-pulse' : 'bg-slate-500'}`}></div>
      </div>

      <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
        {messages.map((msg, idx) => (
          <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
            <div className={`max-w-[85%] p-3 rounded-lg text-sm ${
              msg.role === 'user' 
                ? 'bg-blue-600 text-white rounded-br-none' 
                : 'bg-white border border-slate-200 text-slate-800 rounded-bl-none shadow-sm'
            }`}>
              {renderMessageContent(msg.content)}
            </div>
          </div>
        ))}
        {isTyping && (
          <div className="flex justify-start">
            <div className="bg-white border border-slate-200 p-3 rounded-lg rounded-bl-none shadow-sm flex space-x-1">
              <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style={{ animationDelay: '0ms'}}></div>
              <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style={{ animationDelay: '150ms'}}></div>
              <div className="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style={{ animationDelay: '300ms'}}></div>
            </div>
          </div>
        )}
        <div ref={messagesEndRef} />
      </div>

      <div className="p-4 bg-white border-t border-slate-200">
        <div className="flex gap-2">
          <input
            type="text"
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyDown={(e) => e.key === 'Enter' && handleSend()}
            placeholder="Ask about rainfall, soil moisture, or risk..."
            className="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
            disabled={isTyping}
          />
          <button
            onClick={() => handleSend()}
            disabled={isTyping || !input.trim()}
            className="bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 text-white px-4 py-2 rounded-lg font-medium transition-colors text-sm"
          >
            Send
          </button>
        </div>
      </div>
    </div>
  );
};

export default ChatInterface;

================================================================================
FILE: components/HistoricalChart.tsx
================================================================================
import React from 'react';
import { ComposedChart, Area, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } from 'recharts';
import { HistoricalDataPoint } from '../types';

interface HistoricalChartProps {
  data: HistoricalDataPoint[];
  regionName: string;
  title?: string;
}

const HistoricalChart: React.FC<HistoricalChartProps> = ({ data, regionName, title = "7-Day Forecast Trend" }) => {
  return (
    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 h-full flex flex-col overflow-visible relative z-0">
      <div className="mb-3 flex justify-between items-start">
        <div>
          <h3 className="font-bold text-lg text-slate-800">{title}</h3>
          <p className="text-xs text-slate-500">Conditions for {regionName}</p>
        </div>
        
        {/* Custom Legend / Key */}
        <div className="hidden sm:flex gap-4 text-[10px] mr-32 bg-slate-50 p-1.5 rounded-lg border border-slate-100">
           <div className="flex flex-col gap-1">
              <span className="text-slate-400 font-semibold uppercase tracking-wider text-[9px]">Left Axis (%)</span>
              <div className="flex gap-2">
                 <div className="flex items-center gap-1"><span className="w-2 h-2 bg-blue-300 rounded-sm"></span><span className="text-slate-600">Soil</span></div>
                 <div className="flex items-center gap-1"><span className="w-2 h-2 bg-red-300 rounded-sm"></span><span className="text-slate-600">Risk</span></div>
                 <div className="flex items-center gap-1"><span className="w-3 h-0.5 border-t-2 border-dashed border-sky-500"></span><span className="text-slate-600">Rain</span></div>
              </div>
           </div>
           <div className="w-px bg-slate-200"></div>
           <div className="flex flex-col gap-1">
              <span className="text-orange-400 font-semibold uppercase tracking-wider text-[9px]">Right Axis (¬∞C)</span>
              <div className="flex items-center gap-1"><span className="w-3 h-0.5 bg-orange-500 rounded-full"></span><span className="text-slate-600">Temp</span></div>
           </div>
        </div>
      </div>

      <div className="flex-1 pb-2 min-h-[200px] sm:min-h-[180px] max-h-[250px] sm:max-h-[220px]">
        {(!data || data.length === 0) ? (
          <div className="h-full w-full flex items-center justify-center bg-slate-50 rounded-lg border border-dashed border-slate-300">
            <p className="text-slate-400 text-sm font-medium">[No Data Available]</p>
          </div>
        ) : (
          <ResponsiveContainer width="100%" height="100%">
            <ComposedChart
              data={data}
              margin={{
                top: 5,
                right: 0,
                left: -10,
                bottom: 5,
              }}
            >
              <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
              <XAxis dataKey="date" axisLine={false} tickLine={false} tick={{fontSize: 11, fill: '#64748b'}} dy={5} />
              
              {/* Left Axis: 0-100 for Risk, Soil, Rain Prob */}
              <YAxis yAxisId="left" axisLine={false} tickLine={false} tick={{fontSize: 11, fill: '#64748b'}} domain={[0, 100]} />
              
              {/* Right Axis: Temperature */}
              <YAxis yAxisId="right" orientation="right" axisLine={false} tickLine={false} tick={{fontSize: 11, fill: '#f97316'}} unit="¬∞" domain={['auto', 'auto']} />
              
              <Tooltip
                contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 10px 15px -3px rgb(0 0 0 / 0.1)', zIndex: 50 }}
                labelStyle={{ fontWeight: 'bold', color: '#334155' }}
                allowEscapeViewBox={{ x: true, y: true }}
              />
              {/* Legend removed - moved to header */}
              
              {/* Background Areas */}
              <Area
                yAxisId="left"
                type="monotone"
                dataKey="soil_moisture"
                name="Soil Moisture"
                stackId="1"
                stroke="#3b82f6"
                fill="#93c5fd"
                fillOpacity={0.6}
              />
              <Area
                yAxisId="left"
                type="monotone"
                dataKey="risk_score"
                name="Drought Risk"
                stackId="1"
                stroke="#ef4444"
                fill="#fca5a5"
                fillOpacity={0.6}
              />

              {/* Lines for specific metrics */}
              <Line
                yAxisId="left"
                type="monotone"
                dataKey="rain_probability"
                name="Rain Prob %"
                stroke="#0ea5e9"
                strokeWidth={2}
                strokeDasharray="4 4"
                dot={false}
              />
              
              <Line
                yAxisId="right"
                type="monotone"
                dataKey="temp"
                name="Temp (¬∞C)"
                stroke="#f97316"
                strokeWidth={2}
                dot={{ r: 3, fill: '#f97316' }}
              />
            </ComposedChart>
          </ResponsiveContainer>
        )}
      </div>
    </div>
  );
};

export default HistoricalChart;


================================================================================
FILE: components/StatusCard.tsx
================================================================================
import React from 'react';

interface StatusCardProps {
  title: string;
  value: string | number;
  subtitle?: string;
  status?: 'success' | 'warning' | 'error' | 'neutral';
  icon?: React.ReactNode;
}

const StatusCard: React.FC<StatusCardProps> = ({ title, value, subtitle, status = 'neutral', icon }) => {
  const getStatusColor = () => {
    switch (status) {
      case 'success': return 'bg-green-100 text-green-800 border-green-200';
      case 'warning': return 'bg-yellow-100 text-yellow-800 border-yellow-200';
      case 'error': return 'bg-red-100 text-red-800 border-red-200';
      default: return 'bg-white text-slate-800 border-slate-200';
    }
  };

  return (
    <div className={`p-4 rounded-lg border shadow-sm ${getStatusColor()} transition-all duration-200`}>
      <div className="flex justify-between items-start">
        <div>
          <h3 className="text-xs font-semibold uppercase tracking-wider opacity-70 mb-1">{title}</h3>
          <div className="text-2xl font-bold">{value}</div>
          {subtitle && <div className="text-sm opacity-80 mt-1">{subtitle}</div>}
        </div>
        {icon && <div className="opacity-50">{icon}</div>}
      </div>
    </div>
  );
};

export default StatusCard;

================================================================================
FILE: components/QuickStats.tsx
================================================================================
import React from 'react';

interface QuickStatsProps {
  totalRegions: number;
  regionsInDrought: number;
  highestRiskRegion: string;
  nationalAverage: number;
}

const QuickStats: React.FC<QuickStatsProps> = ({
  totalRegions,
  regionsInDrought,
  highestRiskRegion,
  nationalAverage
}) => {
  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      {/* Total Regions Monitored */}
      <div className="bg-white rounded-xl p-4 border border-slate-200 shadow-sm">
        <div className="flex items-center justify-between">
          <div>
            <p className="text-xs text-slate-500 font-medium uppercase tracking-wide">Regions Monitored</p>
            <p className="text-3xl font-bold text-slate-900 mt-1">{totalRegions}</p>
          </div>
          <div className="bg-blue-100 p-3 rounded-lg">
            <svg className="w-6 h-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
            </svg>
          </div>
        </div>
      </div>

      {/* Regions in Drought */}
      <div className="bg-white rounded-xl p-4 border border-slate-200 shadow-sm">
        <div className="flex items-center justify-between">
          <div>
            <p className="text-xs text-slate-500 font-medium uppercase tracking-wide">High Risk Regions</p>
            <p className="text-3xl font-bold text-orange-600 mt-1">{regionsInDrought}</p>
          </div>
          <div className="bg-orange-100 p-3 rounded-lg">
            <svg className="w-6 h-6 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
        </div>
      </div>

      {/* Highest Risk Region */}
      <div className="bg-white rounded-xl p-4 border border-slate-200 shadow-sm">
        <div className="flex items-center justify-between">
          <div className="flex-1 min-w-0">
            <p className="text-xs text-slate-500 font-medium uppercase tracking-wide">Highest Risk</p>
            <p className="text-xl font-bold text-red-600 mt-1 truncate">{highestRiskRegion || 'N/A'}</p>
          </div>
          <div className="bg-red-100 p-3 rounded-lg ml-2">
            <svg className="w-6 h-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z" />
            </svg>
          </div>
        </div>
      </div>

      {/* National Average */}
      <div className="bg-white rounded-xl p-4 border border-slate-200 shadow-sm">
        <div className="flex items-center justify-between">
          <div>
            <p className="text-xs text-slate-500 font-medium uppercase tracking-wide">National Average</p>
            <p className="text-3xl font-bold text-slate-900 mt-1">{nationalAverage}<span className="text-lg text-slate-500">/100</span></p>
          </div>
          <div className={`${nationalAverage > 60 ? 'bg-orange-100' : nationalAverage > 40 ? 'bg-yellow-100' : 'bg-green-100'} p-3 rounded-lg`}>
            <svg className={`w-6 h-6 ${nationalAverage > 60 ? 'text-orange-600' : nationalAverage > 40 ? 'text-yellow-600' : 'text-green-600'}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
          </div>
        </div>
      </div>
    </div>
  );
};

export default QuickStats;


================================================================================
FILE: components/RegionSearch.tsx
================================================================================
import React, { useState, useRef, useEffect, forwardRef, useImperativeHandle } from 'react';
import { Region } from '../types';

interface RegionSearchProps {
  regions: Region[];
  onRegionSelect: (region: Region) => void;
}

export interface RegionSearchRef {
  focus: () => void;
  clear: () => void;
}

const RegionSearch = forwardRef<RegionSearchRef, RegionSearchProps>(({ regions, onRegionSelect }, ref) => {
  const [searchTerm, setSearchTerm] = useState('');
  const [isOpen, setIsOpen] = useState(false);
  const [selectedIndex, setSelectedIndex] = useState(-1);
  const inputRef = useRef<HTMLInputElement>(null);
  const dropdownRef = useRef<HTMLDivElement>(null);

  // Expose methods to parent component via ref
  useImperativeHandle(ref, () => ({
    focus: () => {
      inputRef.current?.focus();
    },
    clear: () => {
      handleClear();
    }
  }));

  // Filter regions based on search term with fuzzy matching
  const filteredRegions = searchTerm.trim()
    ? regions.filter(region =>
        region.name.toLowerCase().includes(searchTerm.toLowerCase())
      ).slice(0, 6) // Limit to 6 results
    : [];

  // Close dropdown when clicking outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (
        dropdownRef.current &&
        !dropdownRef.current.contains(event.target as Node) &&
        inputRef.current &&
        !inputRef.current.contains(event.target as Node)
      ) {
        setIsOpen(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  // Handle keyboard navigation
  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (!isOpen && filteredRegions.length > 0 && (e.key === 'ArrowDown' || e.key === 'ArrowUp')) {
      setIsOpen(true);
      return;
    }

    switch (e.key) {
      case 'ArrowDown':
        e.preventDefault();
        setSelectedIndex(prev =>
          prev < filteredRegions.length - 1 ? prev + 1 : prev
        );
        break;
      case 'ArrowUp':
        e.preventDefault();
        setSelectedIndex(prev => (prev > 0 ? prev - 1 : 0));
        break;
      case 'Enter':
        e.preventDefault();
        if (selectedIndex >= 0 && selectedIndex < filteredRegions.length) {
          handleSelectRegion(filteredRegions[selectedIndex]);
        }
        break;
      case 'Escape':
        e.preventDefault();
        setIsOpen(false);
        setSelectedIndex(-1);
        break;
    }
  };

  // Handle region selection
  const handleSelectRegion = (region: Region) => {
    setSearchTerm(region.name);
    setIsOpen(false);
    setSelectedIndex(-1);
    onRegionSelect(region);
  };

  // Handle input change
  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setSearchTerm(value);
    setIsOpen(value.trim().length > 0);
    setSelectedIndex(-1);
  };

  // Clear search
  const handleClear = () => {
    setSearchTerm('');
    setIsOpen(false);
    setSelectedIndex(-1);
    inputRef.current?.focus();
  };

  // Highlight matching text
  const highlightMatch = (text: string, query: string) => {
    if (!query.trim()) return text;

    const regex = new RegExp(`(${query})`, 'gi');
    const parts = text.split(regex);

    return parts.map((part, index) =>
      regex.test(part) ? (
        <span key={index} className="font-semibold text-blue-700">
          {part}
        </span>
      ) : (
        <span key={index}>{part}</span>
      )
    );
  };

  return (
    <div className="relative w-full max-w-md">
      {/* Search Input */}
      <div className="relative">
        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg
            className="h-5 w-5 text-slate-400"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
            />
          </svg>
        </div>
        <input
          ref={inputRef}
          type="text"
          value={searchTerm}
          onChange={handleInputChange}
          onKeyDown={handleKeyDown}
          onFocus={() => {
            if (searchTerm.trim() && filteredRegions.length > 0) {
              setIsOpen(true);
            }
          }}
          placeholder="Search regions..."
          className="block w-full pl-10 pr-10 py-2.5 border border-slate-300 rounded-lg text-sm
                     placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500
                     focus:border-transparent bg-white shadow-sm transition-all"
        />
        {searchTerm && (
          <button
            onClick={handleClear}
            className="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-400
                       hover:text-slate-600 transition-colors"
            aria-label="Clear search"
          >
            <svg
              className="h-5 w-5"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        )}
      </div>

      {/* Dropdown Results */}
      {isOpen && filteredRegions.length > 0 && (
        <div
          ref={dropdownRef}
          className="absolute z-50 w-full mt-2 bg-white border border-slate-200 rounded-lg
                     shadow-lg max-h-80 overflow-y-auto"
        >
          <ul className="py-1">
            {filteredRegions.map((region, index) => (
              <li key={region.name}>
                <button
                  onClick={() => handleSelectRegion(region)}
                  onMouseEnter={() => setSelectedIndex(index)}
                  className={`w-full text-left px-4 py-3 hover:bg-blue-50 transition-colors
                             flex items-center justify-between group
                             ${selectedIndex === index ? 'bg-blue-50' : ''}`}
                >
                  <div className="flex-1">
                    <div className="text-sm font-medium text-slate-900">
                      {highlightMatch(region.name, searchTerm)}
                    </div>
                    <div className="text-xs text-slate-500 mt-0.5">
                      Lat: {region.lat.toFixed(2)}, Lon: {region.lon.toFixed(2)}
                    </div>
                  </div>
                  <div className="ml-3 flex items-center gap-2">
                    <div className="text-xs text-slate-400 group-hover:text-blue-600 transition-colors">
                      Risk: {region.baseRisk}
                    </div>
                    <svg
                      className="h-4 w-4 text-slate-300 group-hover:text-blue-600 transition-colors"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M9 5l7 7-7 7"
                      />
                    </svg>
                  </div>
                </button>
              </li>
            ))}
          </ul>
        </div>
      )}

      {/* No Results Message */}
      {isOpen && searchTerm.trim() && filteredRegions.length === 0 && (
        <div
          ref={dropdownRef}
          className="absolute z-50 w-full mt-2 bg-white border border-slate-200 rounded-lg
                     shadow-lg py-4 px-4"
        >
          <div className="text-center text-slate-500 text-sm">
            <svg
              className="h-8 w-8 mx-auto mb-2 text-slate-300"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M12 12h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              />
            </svg>
            <p className="font-medium">No regions found</p>
            <p className="text-xs mt-1">Try adjusting your search</p>
          </div>
        </div>
      )}
    </div>
  );
});

RegionSearch.displayName = 'RegionSearch';

export default RegionSearch;


================================================================================
FILE: components/DataRefreshIndicator.tsx
================================================================================
import React, { useState, useEffect } from 'react';

interface DataRefreshIndicatorProps {
  lastUpdated: Date;
  onRefresh: () => void;
  isRefreshing: boolean;
}

const DataRefreshIndicator: React.FC<DataRefreshIndicatorProps> = ({
  lastUpdated,
  onRefresh,
  isRefreshing
}) => {
  const [timeAgo, setTimeAgo] = useState<string>('');

  useEffect(() => {
    const calculateTimeAgo = () => {
      const now = new Date();
      const diffInSeconds = Math.floor((now.getTime() - lastUpdated.getTime()) / 1000);

      if (diffInSeconds < 60) {
        return 'Just now';
      } else if (diffInSeconds < 3600) {
        const mins = Math.floor(diffInSeconds / 60);
        return `${mins} min${mins !== 1 ? 's' : ''} ago`;
      } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
      } else {
        const days = Math.floor(diffInSeconds / 86400);
        return `${days} day${days !== 1 ? 's' : ''} ago`;
      }
    };

    calculateTimeAgo();
    setTimeAgo(calculateTimeAgo());

    // Update every 30 seconds
    const interval = setInterval(() => {
      setTimeAgo(calculateTimeAgo());
    }, 30000);

    return () => clearInterval(interval);
  }, [lastUpdated]);

  return (
    <div className="flex items-center gap-3 px-3 py-1 bg-slate-100 text-slate-600 rounded-full border border-slate-200">
      {/* Timestamp */}
      <div className="flex items-center gap-2">
        <svg
          className="w-3.5 h-3.5 text-slate-500"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
        <span className="text-xs font-medium">
          Last updated: {timeAgo}
        </span>
      </div>

      {/* Refresh Button */}
      <button
        onClick={onRefresh}
        disabled={isRefreshing}
        className="flex items-center justify-center w-6 h-6 rounded-full hover:bg-slate-200 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
        title="Refresh data"
        aria-label="Refresh data"
      >
        <svg
          className={`w-3.5 h-3.5 text-slate-600 ${isRefreshing ? 'animate-spin' : ''}`}
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
          />
        </svg>
      </button>
    </div>
  );
};

export default DataRefreshIndicator;


================================================================================
FILE: components/CouncilAlerts.tsx
================================================================================
import React, { useEffect, useState } from 'react';
import { fetchCouncilAlerts } from '../services/api';

interface CouncilAlert {
  title: string;
  source: string;
  link: string;
  severity: 'critical' | 'warning' | 'info';
  date: string;
  region: string;
}

const CouncilAlerts: React.FC = () => {
  const [alerts, setAlerts] = useState<CouncilAlert[]>([]);

  useEffect(() => {
    let timeoutId: NodeJS.Timeout;
    
    const loadAlerts = async () => {
      try {
        const data = await fetchCouncilAlerts();
        setAlerts(data);
      } catch (error) {
        console.error("Failed to load council alerts, retrying in 10 minutes...", error);
        // Retry after 10 minutes (600,000 ms)
        timeoutId = setTimeout(loadAlerts, 600000);
      }
    };
    
    loadAlerts();
    
    return () => {
      if (timeoutId) clearTimeout(timeoutId);
    };
  }, []);

  if (alerts.length === 0) return null;

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case 'critical': return 'text-red-400';
      case 'warning': return 'text-orange-400';
      case 'info': return 'text-blue-400';
      default: return 'text-slate-400';
    }
  };

  const getSeverityIcon = (severity: string) => {
    switch (severity) {
      case 'critical':
        return (
          <svg className="w-3.5 h-3.5 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
            <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
          </svg>
        );
      case 'warning':
        return (
          <svg className="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
          </svg>
        );
      case 'info':
        return (
          <svg className="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" />
          </svg>
        );
      default:
        return null;
    }
  };

  return (
    <div className="w-full bg-gradient-to-r from-slate-900 via-slate-800 to-slate-900 text-white overflow-hidden py-3 px-4 flex items-center gap-4 border-t border-b border-slate-700 shadow-lg">
      <div className="flex items-center gap-2.5 text-orange-400 whitespace-nowrap">
        <svg className="w-4 h-4 animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
        </svg>
        <span className="text-xs font-bold uppercase tracking-wider">Water Alerts</span>
      </div>

      <div className="flex-1 overflow-hidden relative h-7">
        <div className="animate-marquee whitespace-nowrap absolute flex gap-8 items-center">
          {alerts.concat(alerts).map((alert, idx) => (
            <a
              key={idx}
              href={alert.link}
              target="_blank"
              rel="noopener noreferrer"
              className="text-sm text-slate-200 hover:text-white hover:underline transition-colors flex items-center gap-2.5 group"
            >
              <span className={`${getSeverityColor(alert.severity)} flex items-center gap-1`}>
                {getSeverityIcon(alert.severity)}
              </span>
              <span className="text-slate-400 text-xs font-medium">[{alert.region}]</span>
              <span className="group-hover:text-white">{alert.title}</span>
              <span className="text-slate-500 text-xs">‚Ä¢ {alert.date}</span>
            </a>
          ))}
        </div>
      </div>

      <div className="text-xs text-slate-500 whitespace-nowrap hidden md:block">
        {alerts.length} active {alerts.length === 1 ? 'alert' : 'alerts'}
      </div>

      <style>{`
        .animate-marquee {
          animation: marquee 50s linear infinite;
        }
        @keyframes marquee {
          0% { transform: translateX(0); }
          100% { transform: translateX(-50%); }
        }
        .animate-marquee:hover {
          animation-play-state: paused;
        }
      `}</style>
    </div>
  );
};

export default CouncilAlerts;


================================================================================
FILE: components/NewsTicker.tsx
================================================================================
import React, { useEffect, useState } from 'react';
import { fetchNewsHeadlines } from '../services/api';

interface NewsHeadline {
  title: string;
  source: string;
  link: string;
  published: string;
}

const NewsTicker: React.FC = () => {
  const [headlines, setHeadlines] = useState<NewsHeadline[]>([]);

  useEffect(() => {
    const loadHeadlines = async () => {
      const data = await fetchNewsHeadlines();
      // Filter out news older than 2 weeks
      const twoWeeksAgo = new Date();
      twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);

      const recentHeadlines = data.filter(headline => {
        const publishedDate = new Date(headline.published);
        return publishedDate >= twoWeeksAgo;
      });

      setHeadlines(recentHeadlines);
    };
    loadHeadlines();
  }, []);

  if (headlines.length === 0) return null;

  return (
    <div className="w-full bg-gradient-to-r from-emerald-900 via-teal-900 to-emerald-900 text-white overflow-hidden py-3 px-4 flex items-center gap-4 border-t border-b border-emerald-700 shadow-lg">
      <div className="flex items-center gap-2.5 text-emerald-300 whitespace-nowrap">
        <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
        </svg>
        <span className="text-xs font-bold uppercase tracking-wider">Rural News</span>
      </div>

      <div className="flex-1 overflow-hidden relative h-7">
        <div className="animate-news-scroll whitespace-nowrap absolute flex gap-8 items-center">
          {headlines.concat(headlines).map((headline, idx) => (
            <a
              key={idx}
              href={headline.link}
              target="_blank"
              rel="noopener noreferrer"
              className="text-sm text-slate-200 hover:text-white hover:underline transition-colors flex items-center gap-2.5 group"
            >
              <span className="text-emerald-400 text-xs font-medium">[{headline.source}]</span>
              <span className="group-hover:text-white">{headline.title}</span>
              <span className="text-slate-500 text-xs">‚Ä¢ {new Date(headline.published).toLocaleDateString('en-NZ', { month: 'short', day: 'numeric' })}</span>
            </a>
          ))}
        </div>
      </div>

      <div className="text-xs text-slate-500 whitespace-nowrap hidden md:block">
        {headlines.length} {headlines.length === 1 ? 'headline' : 'headlines'}
      </div>

      <style>{`
        .animate-news-scroll {
          animation: news-scroll 60s linear infinite;
        }
        @keyframes news-scroll {
          0% { transform: translateX(0); }
          100% { transform: translateX(-50%); }
        }
        .animate-news-scroll:hover {
          animation-play-state: paused;
        }
      `}</style>
    </div>
  );
};

export default NewsTicker;


================================================================================
FILE: components/WeatherNarrative.tsx
================================================================================
import React, { useEffect, useState } from 'react';
import { API_BASE_URL } from '../constants';

interface KaitiakiWaiData {
  title: string;
  tagline: string;
  narrative: string;
  mode: 'stability' | 'tension' | 'acceleration' | 'crisis';
  risk_score: number;
  trajectory: 'improving' | 'stable' | 'worsening';
  updated_at: string;
  sentences?: string[];
}

const WeatherNarrative: React.FC = () => {
  const [data, setData] = useState<KaitiakiWaiData | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const loadNarrative = async () => {
      try {
        console.log('WeatherNarrative: Fetching narrative...');
        const response = await fetch(`${API_BASE_URL}/api/public/weather-narrative`);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const narrativeData = await response.json();
        console.log('WeatherNarrative: Data loaded:', narrativeData);

        // Split narrative into sentences for scrolling
        const sentences = narrativeData.narrative
          .split(/(?<=[.!?])\s+/)
          .filter((s: string) => s.trim().length > 0);

        setData({ ...narrativeData, sentences });
        setError(null);
        setIsLoading(false);
      } catch (error) {
        console.error('WeatherNarrative: Failed to load:', error);
        setError(error instanceof Error ? error.message : 'Unknown error');
        setIsLoading(false);
      }
    };

    loadNarrative();

    // Refresh every 30 minutes
    const interval = setInterval(loadNarrative, 30 * 60 * 1000);
    return () => clearInterval(interval);
  }, []);

  if (error) {
    console.error('WeatherNarrative: Error state:', error);
    return (
      <div className="w-full bg-gradient-to-r from-slate-800 to-slate-900 text-white py-4 px-6 flex items-center justify-center gap-2 border-t border-b border-slate-700">
        <span className="text-amber-400">‚ö†</span>
        <span className="text-sm text-slate-300">Narrative temporarily unavailable</span>
        <button
          onClick={() => window.location.reload()}
          className="ml-4 text-xs bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded"
        >
          Retry
        </button>
      </div>
    );
  }

  if (isLoading) {
    console.log('WeatherNarrative: Loading...');
    return null;
  }

  if (!data) {
    console.log('WeatherNarrative: No data');
    return null;
  }

  console.log('WeatherNarrative: Rendering with data:', data.narrative.substring(0, 50));

  const sentences = data.sentences || [data.narrative];

  const modeColors = {
    stability: 'from-emerald-950 via-teal-900 to-emerald-950 border-emerald-800',
    tension: 'from-amber-950 via-yellow-900 to-amber-950 border-amber-800',
    acceleration: 'from-orange-950 via-red-900 to-orange-950 border-orange-800',
    crisis: 'from-red-950 via-rose-900 to-red-950 border-red-800'
  };

  const trajectoryIcons = {
    improving: '‚Üó',
    stable: '‚Üí',
    worsening: '‚Üò'
  };

  return (
    <div className={`w-full bg-gradient-to-r ${modeColors[data.mode || 'stability']} text-white overflow-hidden py-4 px-6 flex items-center gap-4 border-t border-b shadow-xl transition-colors duration-1000`}>
      <div className="flex flex-col items-start whitespace-nowrap min-w-[140px]">
        <div className="flex items-center gap-2 text-white/90">
          <span className="text-lg">{trajectoryIcons[data.trajectory || 'stable']}</span>
          <span className="text-sm font-bold uppercase tracking-widest">{data.title || 'Kaitiaki Wai'}</span>
        </div>
        <span className="text-[10px] text-white/60 italic">{data.tagline || 'Stories of stewardship'}</span>
      </div>

      <div className="flex-1 overflow-hidden relative h-8">
        <div className="animate-narrative-scroll whitespace-nowrap absolute flex gap-8 items-center">
          {sentences.concat(sentences).map((sentence, idx) => (
            <span key={idx} className="text-sm leading-relaxed text-slate-100 italic font-light tracking-wide flex items-center gap-8">
              {sentence}
              <span className="text-white/30">‚Ä¢</span>
            </span>
          ))}
        </div>
      </div>

      <div className="flex flex-col items-end gap-0.5 text-xs text-white/60 whitespace-nowrap min-w-[100px]">
        <div className="flex items-center gap-2">
          <span className="uppercase tracking-wider font-semibold text-[10px]">{data.mode || 'STABILITY'}</span>
          <span className={`w-1.5 h-1.5 rounded-full ${data.mode === 'crisis' ? 'bg-red-500 animate-pulse' : 'bg-emerald-400'}`}></span>
        </div>
        <span className="text-[10px]">Risk Score {data.risk_score || 50}/100</span>
      </div>

      <style>{`
        .animate-narrative-scroll {
          animation: narrative-scroll 120s linear infinite;
        }
        @keyframes narrative-scroll {
          0% { transform: translateX(0); }
          100% { transform: translateX(-50%); }
        }
        .animate-narrative-scroll:hover {
          animation-play-state: paused;
        }
      `}</style>
    </div>
  );
};

export default WeatherNarrative;


================================================================================
FILE: components/ShortcutsHelpModal.tsx
================================================================================
import React, { useEffect } from 'react';

interface ShortcutsHelpModalProps {
  isOpen: boolean;
  onClose: () => void;
}

const ShortcutsHelpModal: React.FC<ShortcutsHelpModalProps> = ({ isOpen, onClose }) => {
  useEffect(() => {
    if (isOpen) {
      // Lock body scroll when modal is open
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = 'unset';
    }

    return () => {
      document.body.style.overflow = 'unset';
    };
  }, [isOpen]);

  useEffect(() => {
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape' && isOpen) {
        onClose();
      }
    };

    window.addEventListener('keydown', handleEscape);
    return () => window.removeEventListener('keydown', handleEscape);
  }, [isOpen, onClose]);

  if (!isOpen) return null;

  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 animate-fadeIn"
      onClick={onClose}
    >
      <div
        className="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden animate-fadeInUp"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Header */}
        <div className="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="bg-white bg-opacity-20 p-2 rounded-lg">
              <svg className="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
              </svg>
            </div>
            <h2 className="text-xl font-bold text-white">Keyboard Shortcuts</h2>
          </div>
          <button
            onClick={onClose}
            className="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-2 transition-colors"
            aria-label="Close modal"
          >
            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        {/* Content */}
        <div className="px-6 py-5 max-h-96 overflow-y-auto">
          {/* Actions Section */}
          <div className="mb-6">
            <h3 className="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-3">Actions</h3>
            <div className="space-y-2">
              <ShortcutRow
                keys={['R']}
                description="Refresh data"
                icon={
                  <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                  </svg>
                }
              />
            </div>
          </div>

          {/* Navigation Section */}
          <div className="mb-6">
            <h3 className="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-3">Navigation</h3>
            <div className="space-y-2">
              <ShortcutRow
                keys={['/']}
                description="Focus search"
                icon={
                  <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                  </svg>
                }
              />
              <ShortcutRow
                keys={['Esc']}
                description="Clear search / Close panels"
                icon={
                  <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                }
              />
            </div>
          </div>

          {/* Help Section */}
          <div>
            <h3 className="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-3">Help</h3>
            <div className="space-y-2">
              <ShortcutRow
                keys={['?']}
                description="Show this help"
                icon={
                  <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                }
              />
            </div>
          </div>
        </div>

        {/* Footer */}
        <div className="bg-slate-50 px-6 py-4 border-t border-slate-200">
          <p className="text-xs text-slate-500 text-center">
            Press <kbd className="px-2 py-1 bg-white border border-slate-300 rounded text-slate-700 font-mono text-xs">Esc</kbd> or click outside to close
          </p>
        </div>
      </div>

      <style>{`
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        @keyframes fadeInUp {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        .animate-fadeIn {
          animation: fadeIn 0.2s ease-out;
        }
        .animate-fadeInUp {
          animation: fadeInUp 0.3s ease-out;
        }
      `}</style>
    </div>
  );
};

interface ShortcutRowProps {
  keys: string[];
  description: string;
  icon: React.ReactNode;
}

const ShortcutRow: React.FC<ShortcutRowProps> = ({ keys, description, icon }) => {
  return (
    <div className="flex items-center justify-between py-2 px-3 rounded-lg hover:bg-slate-50 transition-colors">
      <div className="flex items-center gap-3">
        <div className="text-slate-400">{icon}</div>
        <span className="text-sm text-slate-700">{description}</span>
      </div>
      <div className="flex items-center gap-1">
        {keys.map((key, index) => (
          <kbd
            key={index}
            className="px-2 py-1 bg-white border border-slate-300 rounded shadow-sm text-slate-700 font-mono text-xs min-w-[28px] text-center"
          >
            {key}
          </kbd>
        ))}
      </div>
    </div>
  );
};

export default ShortcutsHelpModal;


================================================================================
FILE: components/QuickStatsSkeleton.tsx
================================================================================
import React from 'react';

const QuickStatsSkeleton: React.FC = () => {
  return (
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      {/* Skeleton Card 1 */}
      <div className="bg-white rounded-xl p-4 border border-slate-200 shadow-sm animate-pulse">
        <div className="flex items-center justify-between">
          <div className="flex-1">
            <div className="h-3 bg-slate-200 rounded w-24 mb-2"></div>
            <div className="h-8 bg-slate-300 rounded w-12"></div>
          </div>
          <div className="bg-slate-200 p-3 rounded-lg">
            <div className="w-6 h-6 bg-slate-300 rounded"></div>
          </div>
        </div>
      </div>

      {/* Skeleton Card 2 */}
      <div className="bg-white rounded-xl p-4 border border-slate-200 shadow-sm animate-pulse">
        <div className="flex items-center justify-between">
          <div className="flex-1">
            <div className="h-3 bg-slate-200 rounded w-24 mb-2"></div>
            <div className="h-8 bg-slate-300 rounded w-12"></div>
          </div>
          <div className="bg-slate-200 p-3 rounded-lg">
            <div className="w-6 h-6 bg-slate-300 rounded"></div>
          </div>
        </div>
      </div>

      {/* Skeleton Card 3 */}
      <div className="bg-white rounded-xl p-4 border border-slate-200 shadow-sm animate-pulse">
        <div className="flex items-center justify-between">
          <div className="flex-1">
            <div className="h-3 bg-slate-200 rounded w-24 mb-2"></div>
            <div className="h-8 bg-slate-300 rounded w-20"></div>
          </div>
          <div className="bg-slate-200 p-3 rounded-lg">
            <div className="w-6 h-6 bg-slate-300 rounded"></div>
          </div>
        </div>
      </div>

      {/* Skeleton Card 4 */}
      <div className="bg-white rounded-xl p-4 border border-slate-200 shadow-sm animate-pulse">
        <div className="flex items-center justify-between">
          <div className="flex-1">
            <div className="h-3 bg-slate-200 rounded w-24 mb-2"></div>
            <div className="h-8 bg-slate-300 rounded w-16"></div>
          </div>
          <div className="bg-slate-200 p-3 rounded-lg">
            <div className="w-6 h-6 bg-slate-300 rounded"></div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default QuickStatsSkeleton;


================================================================================
FILE: components/WeatherMetricsSkeleton.tsx
================================================================================
import React from 'react';

const WeatherMetricsSkeleton: React.FC = () => {
  return (
    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 animate-pulse">
      {/* Header Skeleton */}
      <div className="flex items-center justify-between mb-4">
        <div className="h-6 bg-slate-300 rounded w-48"></div>
        <div className="h-5 bg-slate-200 rounded w-16"></div>
      </div>

      {/* Metrics Grid Skeleton */}
      <div className="grid grid-cols-2 gap-4">
        {/* Metric 1 */}
        <div className="p-3 bg-slate-50 rounded-lg">
          <div className="h-3 bg-slate-200 rounded w-20 mb-2"></div>
          <div className="h-7 bg-slate-300 rounded w-24"></div>
        </div>

        {/* Metric 2 */}
        <div className="p-3 bg-slate-50 rounded-lg">
          <div className="h-3 bg-slate-200 rounded w-16 mb-2"></div>
          <div className="h-7 bg-slate-300 rounded w-20"></div>
        </div>

        {/* Metric 3 */}
        <div className="p-3 bg-slate-50 rounded-lg">
          <div className="h-3 bg-slate-200 rounded w-18 mb-2"></div>
          <div className="h-7 bg-slate-300 rounded w-24"></div>
        </div>

        {/* Metric 4 */}
        <div className="p-3 bg-slate-50 rounded-lg">
          <div className="h-3 bg-slate-200 rounded w-20 mb-2"></div>
          <div className="h-7 bg-slate-300 rounded w-20"></div>
        </div>
      </div>
    </div>
  );
};

export default WeatherMetricsSkeleton;


================================================================================
FILE: components/HistoricalChartSkeleton.tsx
================================================================================
import React from 'react';

const HistoricalChartSkeleton: React.FC = () => {
  return (
    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-full flex flex-col animate-pulse" style={{ minHeight: '180px', maxHeight: '220px' }}>
      {/* Header Skeleton */}
      <div className="flex items-center justify-between mb-4">
        <div>
          <div className="h-5 bg-slate-300 rounded w-32 mb-2"></div>
          <div className="h-4 bg-slate-200 rounded w-24"></div>
        </div>
        <div className="h-4 bg-slate-200 rounded w-20"></div>
      </div>

      {/* Chart Area Skeleton */}
      <div className="flex-1 flex items-end justify-between gap-2 px-4">
        {/* Simulated chart bars with varying heights */}
        <div className="flex flex-col items-center flex-1">
          <div className="w-full bg-slate-200 rounded-t" style={{ height: '60%' }}></div>
          <div className="h-3 bg-slate-200 rounded w-8 mt-2"></div>
        </div>
        <div className="flex flex-col items-center flex-1">
          <div className="w-full bg-slate-200 rounded-t" style={{ height: '75%' }}></div>
          <div className="h-3 bg-slate-200 rounded w-8 mt-2"></div>
        </div>
        <div className="flex flex-col items-center flex-1">
          <div className="w-full bg-slate-200 rounded-t" style={{ height: '45%' }}></div>
          <div className="h-3 bg-slate-200 rounded w-8 mt-2"></div>
        </div>
        <div className="flex flex-col items-center flex-1">
          <div className="w-full bg-slate-200 rounded-t" style={{ height: '90%' }}></div>
          <div className="h-3 bg-slate-200 rounded w-8 mt-2"></div>
        </div>
        <div className="flex flex-col items-center flex-1">
          <div className="w-full bg-slate-200 rounded-t" style={{ height: '55%' }}></div>
          <div className="h-3 bg-slate-200 rounded w-8 mt-2"></div>
        </div>
        <div className="flex flex-col items-center flex-1">
          <div className="w-full bg-slate-200 rounded-t" style={{ height: '70%' }}></div>
          <div className="h-3 bg-slate-200 rounded w-8 mt-2"></div>
        </div>
        <div className="flex flex-col items-center flex-1">
          <div className="w-full bg-slate-200 rounded-t" style={{ height: '50%' }}></div>
          <div className="h-3 bg-slate-200 rounded w-8 mt-2"></div>
        </div>
      </div>

      {/* Legend Skeleton */}
      <div className="flex items-center gap-4 mt-4 justify-center">
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 bg-slate-200 rounded"></div>
          <div className="h-3 bg-slate-200 rounded w-16"></div>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 bg-slate-200 rounded"></div>
          <div className="h-3 bg-slate-200 rounded w-20"></div>
        </div>
      </div>
    </div>
  );
};

export default HistoricalChartSkeleton;


================================================================================
FILE: pages/Triggers.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { Link } from 'react-router-dom';
import { TriggerList, TriggerForm } from '../components/triggers';
import { Trigger, TriggerFormData } from '../types';

// Mock data for initial state
const MOCK_TRIGGERS: Trigger[] = [
  {
    id: '1',
    name: 'High Temp Alert - Canterbury',
    region: 'Canterbury',
    conditions: [
      { indicator: 'temp', operator: '>', threshold: 25 }
    ],
    combination_rule: 'any_1',
    is_active: true,
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString(),
    user_id: 'user_1'
  },
  {
    id: '2',
    name: 'Drought Warning - Hawke\'s Bay',
    region: 'Hawke\'s Bay',
    conditions: [
      { indicator: 'rainfall', operator: '<', threshold: 10 },
      { indicator: 'soil_moisture', operator: '<', threshold: 30 }
    ],
    combination_rule: 'all',
    is_active: true,
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString(),
    user_id: 'user_1'
  }
];

const Triggers: React.FC = () => {
  const [triggers, setTriggers] = useState<Trigger[]>([]);
  const [loading, setLoading] = useState(true);
  const [editingTrigger, setEditingTrigger] = useState<Trigger | null>(null);

  useEffect(() => {
    // Simulate API fetch
    const timer = setTimeout(() => {
      setTriggers(MOCK_TRIGGERS);
      setLoading(false);
    }, 1000);
    return () => clearTimeout(timer);
  }, []);

  const handleCreateTrigger = (data: TriggerFormData) => {
    const newTrigger: Trigger = {
      id: Math.random().toString(36).substr(2, 9),
      ...data,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString(),
      user_id: 'user_1'
    };
    setTriggers([newTrigger, ...triggers]);
  };

  const handleUpdateTrigger = (data: TriggerFormData) => {
    if (!editingTrigger) return;
    
    const updatedTriggers = triggers.map(t => 
      t.id === editingTrigger.id 
        ? { ...t, ...data, updated_at: new Date().toISOString() }
        : t
    );
    setTriggers(updatedTriggers);
    setEditingTrigger(null);
  };

  const handleDeleteTrigger = (triggerId: string) => {
    setTriggers(triggers.filter(t => t.id !== triggerId));
  };

  const handleToggleTrigger = (triggerId: string) => {
    setTriggers(triggers.map(t => 
      t.id === triggerId 
        ? { ...t, is_active: !t.is_active }
        : t
    ));
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans">
      <header className="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
          <div className="flex items-center gap-2">
             <Link to="/" className="font-bold text-xl text-slate-900 tracking-tight hover:text-blue-600 transition-colors">
              CKCIAS <span className="text-slate-500 font-normal">Drought Monitor</span>
            </Link>
            <span className="text-slate-300">/</span>
            <h2 className="font-semibold text-slate-700">Alert Triggers</h2>
          </div>
          <Link
            to="/"
            className="text-sm font-medium text-blue-600 hover:text-blue-800"
          >
            Back to Dashboard
          </Link>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div className="lg:col-span-2">
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
              <div className="p-6 border-b border-slate-200">
                <h3 className="text-lg font-bold text-slate-800">Active Triggers</h3>
                <p className="text-sm text-slate-500 mt-1">Manage your automated alert conditions</p>
              </div>
              <div className="p-6">
                <TriggerList 
                  triggers={triggers}
                  loading={loading}
                  onEdit={setEditingTrigger}
                  onDelete={handleDeleteTrigger}
                  onToggle={handleToggleTrigger}
                />
              </div>
            </div>
          </div>
          
          <div className="lg:col-span-1">
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 sticky top-24">
              <h3 className="text-lg font-bold text-slate-800 mb-4">
                {editingTrigger ? 'Edit Trigger' : 'Create New Trigger'}
              </h3>
              <TriggerForm 
                onSubmit={editingTrigger ? handleUpdateTrigger : handleCreateTrigger}
                onCancel={() => setEditingTrigger(null)}
                initialData={editingTrigger}
                userId="user_1"
              />
            </div>
          </div>
        </div>
      </main>
    </div>
  );
};

export default Triggers;


================================================================================
FILE: pages/SystemDynamics.tsx
================================================================================
import React from 'react';
import { Link } from 'react-router-dom';
import SoilMoistureSimulator from '../components/SoilMoistureSimulator';
import RainfallExplorer from '../components/RainfallExplorer';
import WaterRestrictionCalculator from '../components/WaterRestrictionCalculator';
import IrrigationEfficiencyOptimizer from '../components/IrrigationEfficiencyOptimizer';
import PanarchyNestVisualizer from '../components/PanarchyNestVisualizer';
import AquiferDrawdownModel from '../components/AquiferDrawdownModel';

const SystemDynamics: React.FC = () => {
  return (
    <div className="min-h-screen bg-slate-50 font-sans">
      <header className="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <Link to="/" className="font-bold text-xl text-slate-900 tracking-tight hover:text-blue-600 transition-colors">
              CKCIAS <span className="text-slate-500 font-normal">Drought Monitor</span>
            </Link>
            <span className="text-slate-300">/</span>
            <h2 className="font-semibold text-slate-700">System Dynamics</h2>
          </div>
          <Link
            to="/"
            className="text-sm font-medium text-blue-600 hover:text-blue-800"
          >
            Back to Dashboard
          </Link>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {/* Header Section */}
        <div className="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl shadow-sm border border-slate-200 p-6 mb-8">
          <h1 className="text-2xl font-bold text-slate-800 mb-2">System Dynamics Simulators</h1>
          <p className="text-slate-600">
            Interactive models exploring drought system behavior over time. Each simulator shows feedback loops,
            thresholds, delays, and cross-scale effects. All calculations based on empirical data and established models.
          </p>
        </div>

        {/* System Thinking Note */}
        <div className="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded-lg mb-8">
          <div className="flex items-start">
            <div className="flex-shrink-0">
              <svg className="h-6 w-6 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div className="ml-3">
              <h3 className="text-sm font-semibold text-indigo-800">Systems Thinking Approach</h3>
              <p className="text-sm text-indigo-700 mt-1">
                These simulators reveal how drought systems operate through <em>feedback loops</em> (reinforcing and balancing),
                <em>time delays</em> (actions today impact future states), <em>thresholds</em> (non-linear behavior changes),
                <em>stock-flow dynamics</em> (accumulation and depletion), and <em>nested scales</em> (fast farm decisions
                embedded in slow regional/national cycles). Understanding these patterns helps identify high-leverage intervention points.
              </p>
            </div>
          </div>
        </div>

        {/* Simulators Grid */}
        <div className="space-y-8">
          {/* Row 1: Fast Variables (Hours to Days) */}
          <div>
            <h2 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
              <span className="text-green-500">‚ö°</span>
              Fast Variables (Hours to Days)
            </h2>
            <div className="grid grid-cols-1 gap-6">
              <SoilMoistureSimulator />
            </div>
          </div>

          {/* Row 2: Medium Variables (Weeks to Months) */}
          <div>
            <h2 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
              <span className="text-blue-500">üåä</span>
              Medium Variables (Weeks to Months)
            </h2>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <RainfallExplorer />
              <WaterRestrictionCalculator />
            </div>
          </div>

          {/* Row 3: Management & Efficiency */}
          <div>
            <h2 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
              <span className="text-orange-500">üöú</span>
              Management & Efficiency
            </h2>
            <div className="grid grid-cols-1 gap-6">
              <IrrigationEfficiencyOptimizer />
            </div>
          </div>

          {/* Row 4: Slow Variables & Cross-Scale (Years to Decades) */}
          <div>
            <h2 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
              <span className="text-purple-500">üîÆ</span>
              Slow Variables & Cross-Scale (Years to Decades)
            </h2>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <PanarchyNestVisualizer />
              <AquiferDrawdownModel />
            </div>
          </div>
        </div>

        {/* Footer Note */}
        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mt-8">
          <h3 className="font-semibold text-slate-800 mb-3">About These Models</h3>
          <div className="space-y-2 text-sm text-slate-600">
            <p>
              <strong>Data Sources:</strong> All models use empirical data from established sources (e.g., Penman-Monteith ET equations,
              NZ irrigation efficiency standards, real aquifer characteristics). No mock data - only calculations and projections
              based on real parameters.
            </p>
            <p>
              <strong>Educational Purpose:</strong> These simulators are designed to build intuition about drought system dynamics.
              They simplify complex reality to highlight key patterns. For operational decisions, consult professional hydrologists
              and water resource managers.
            </p>
            <p>
              <strong>Theoretical Foundation:</strong> Based on systems thinking frameworks including System Dynamics (Forrester),
              Panarchy Theory (Holling & Gunderson), and resilience science. Each model includes explanatory notes linking theory to practice.
            </p>
          </div>
        </div>
      </main>
    </div>
  );
};

export default SystemDynamics;


================================================================================
FILE: hooks/useKeyboardShortcuts.ts
================================================================================
import { useEffect, useCallback } from 'react';

interface ShortcutConfig {
  key: string;
  action: () => void;
  preventDefault?: boolean;
}

/**
 * Custom hook for managing keyboard shortcuts
 * Automatically detects and prevents shortcuts when typing in input fields
 */
export const useKeyboardShortcuts = ({ shortcuts }: { shortcuts: ShortcutConfig[] }) => {
  const handleKeyPress = useCallback(
    (event: KeyboardEvent) => {
      // Don't trigger shortcuts when typing in input fields, textareas, or contenteditable elements
      const target = event.target as HTMLElement;
      const isTyping =
        target.tagName === 'INPUT' ||
        target.tagName === 'TEXTAREA' ||
        target.isContentEditable;

      if (isTyping) {
        return;
      }

      // Find matching shortcut
      const shortcut = shortcuts.find((s) => s.key.toLowerCase() === event.key.toLowerCase());

      if (shortcut) {
        if (shortcut.preventDefault !== false) {
          event.preventDefault();
        }
        shortcut.action();
      }
    },
    [shortcuts]
  );

  useEffect(() => {
    window.addEventListener('keydown', handleKeyPress);

    return () => {
      window.removeEventListener('keydown', handleKeyPress);
    };
  }, [handleKeyPress]);
};


================================================================================
FILE: utils/toast.ts
================================================================================
import toast from 'react-hot-toast';

export const toastNotifications = {
  triggerFired: (triggerName: string, region: string) => {
    toast.error(
      `Alert Triggered: ${triggerName} in ${region}`,
      {
        duration: 5000,
        icon: 'üö®',
        style: {
          border: '1px solid #EF4444',
          padding: '16px',
          color: '#7F1D1D',
        },
      }
    );
  },

  multipleTriggersFired: (count: number) => {
    toast.error(
      `${count} Alerts Triggered! Check dashboard for details.`,
      {
        duration: 5000,
        icon: 'üö®',
        style: {
          border: '1px solid #EF4444',
          padding: '16px',
          color: '#7F1D1D',
        },
      }
    );
  },

  dataRefreshSuccess: () => {
    toast.success('Data refreshed successfully', {
      duration: 3000,
      icon: 'üîÑ',
    });
  },

  dataRefreshError: () => {
    toast.error('Failed to refresh data. Check connection.', {
      duration: 4000,
      icon: '‚ö†Ô∏è',
    });
  },

  regionLoaded: (regionName: string) => {
    toast.success(`Loaded data for ${regionName}`, {
      duration: 2000,
      icon: 'üìç',
    });
  }
};


================================================================================
FILE: components/AquiferDrawdownModel.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ReferenceLine, ResponsiveContainer } from 'recharts';

const AquiferDrawdownModel: React.FC = () => {
  const [pumpingRate, setPumpingRate] = useState(500000); // L/day
  const [rechargeRate, setRechargeRate] = useState(250); // mm/year
  const [data, setData] = useState<any[]>([]);
  const [criticalYear, setCriticalYear] = useState<number | null>(null);

  useEffect(() => {
    calculateSimulation();
  }, [pumpingRate, rechargeRate]);

  const calculateSimulation = () => {
    const initial_depth = 15; // meters
    let current_depth = initial_depth;
    const aquifer_area_km2 = 50;
    const aquifer_area_m2 = aquifer_area_km2 * 1_000_000;

    // Convert pumping to mm/year
    const annual_pumping_L = pumpingRate * 365;
    const pumping_mm_per_year = (annual_pumping_L / aquifer_area_m2) * 1000;

    // Net change per year
    const net_decline_mm = pumping_mm_per_year - rechargeRate;
    const net_decline_m = net_decline_mm / 1000;

    const results = [];
    let critical_year_found = null;

    for (let year = 0; year <= 20; year++) {
      let status = 'healthy';
      if (current_depth >= 60) {
        status = 'critical';
        if (critical_year_found === null) {
          critical_year_found = year;
        }
      } else if (current_depth >= 40) {
        status = 'concern';
      } else if (current_depth >= 20) {
        status = 'watch';
      }

      results.push({
        year,
        depth: Math.round(current_depth * 10) / 10,
        status,
        net_change: Math.round(net_decline_m * 100) / 100
      });

      current_depth += net_decline_m;
    }

    setData(results);
    setCriticalYear(critical_year_found);
  };

  const finalDepth = data.length > 0 ? data[data.length - 1].depth : 15;
  const netChange = data.length > 1 ? data[1].net_change : 0;
  const isRecovering = netChange < 0;

  return (
    <div className="bg-white rounded-lg shadow-lg p-6">
      <div className="mb-6">
        <h3 className="text-xl font-bold text-gray-800 mb-2">üíß Aquifer Drawdown Model</h3>
        <p className="text-sm text-gray-600">
          Explore long-term groundwater sustainability. Slow variables like aquifer levels take decades to change.
        </p>
      </div>

      {/* Controls */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Pumping Rate: {(pumpingRate / 1000).toFixed(0)}k L/day
          </label>
          <input
            type="range"
            min="100000"
            max="2000000"
            step="100000"
            value={pumpingRate}
            onChange={(e) => setPumpingRate(parseInt(e.target.value))}
            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-red-500"
          />
          <div className="flex justify-between text-xs text-gray-500 mt-1">
            <span>100k L/day</span>
            <span>2M L/day</span>
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Recharge Rate: {rechargeRate} mm/year
          </label>
          <input
            type="range"
            min="100"
            max="500"
            step="50"
            value={rechargeRate}
            onChange={(e) => setRechargeRate(parseInt(e.target.value))}
            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
          />
          <div className="flex justify-between text-xs text-gray-500 mt-1">
            <span>100 mm/yr</span>
            <span>500 mm/yr</span>
          </div>
        </div>
      </div>

      {/* Status Cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div className={`${isRecovering ? 'bg-green-50' : 'bg-red-50'} p-4 rounded-lg`}>
          <div className="text-sm text-gray-600">Net Annual Change</div>
          <div className={`text-2xl font-bold ${isRecovering ? 'text-green-600' : 'text-red-600'}`}>
            {netChange > 0 ? '+' : ''}{netChange}m/year
          </div>
          <div className="text-xs text-gray-500 mt-1">
            {isRecovering ? 'Aquifer recovering!' : 'Aquifer declining'}
          </div>
        </div>

        <div className="bg-blue-50 p-4 rounded-lg">
          <div className="text-sm text-gray-600">Depth in 20 Years</div>
          <div className="text-2xl font-bold text-blue-600">{finalDepth}m</div>
          <div className="text-xs text-gray-500 mt-1">
            from {data[0]?.depth}m today
          </div>
        </div>

        <div className={`${criticalYear !== null && criticalYear <= 20 ? 'bg-red-50' : 'bg-green-50'} p-4 rounded-lg`}>
          <div className="text-sm text-gray-600">Critical Level (60m)</div>
          <div className={`text-2xl font-bold ${criticalYear !== null && criticalYear <= 20 ? 'text-red-600' : 'text-green-600'}`}>
            {criticalYear !== null && criticalYear <= 20 ? `Year ${criticalYear}` : 'Not Reached'}
          </div>
          <div className="text-xs text-gray-500 mt-1">
            {criticalYear !== null && criticalYear <= 20 ? 'pumping becomes unsustainable' : 'within 20 year horizon'}
          </div>
        </div>
      </div>

      {/* Alert */}
      {!isRecovering && (
        <div className="bg-orange-50 border-l-4 border-orange-500 p-4 mb-6">
          <div className="flex">
            <div className="flex-shrink-0">
              <svg className="h-5 w-5 text-orange-400" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
              </svg>
            </div>
            <div className="ml-3">
              <p className="text-sm text-orange-700">
                <strong>Unsustainable Extraction:</strong> Pumping exceeds natural recharge by {Math.abs(netChange)}m/year.
                Aquifer depletion will continue unless pumping is reduced or recharge is enhanced.
              </p>
            </div>
          </div>
        </div>
      )}

      {/* Chart */}
      <div className="h-80 mb-6">
        <ResponsiveContainer width="100%" height="100%">
          <LineChart data={data}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis
              dataKey="year"
              label={{ value: 'Years', position: 'insideBottom', offset: -5 }}
            />
            <YAxis
              label={{ value: 'Depth to Water Table (meters)', angle: -90, position: 'insideLeft' }}
              domain={[0, 80]}
              reversed
            />
            <Tooltip
              content={({ active, payload }) => {
                if (active && payload && payload.length) {
                  const data = payload[0].payload;
                  return (
                    <div className="bg-white p-3 border border-gray-200 rounded shadow">
                      <p className="text-sm font-semibold">Year {data.year}</p>
                      <p className="text-sm">Depth: {data.depth}m below surface</p>
                      <p className="text-sm">Change: {data.net_change > 0 ? '+' : ''}{data.net_change}m/yr</p>
                      <p className="text-sm capitalize">Status: {data.status}</p>
                    </div>
                  );
                }
                return null;
              }}
            />
            <Legend />
            <ReferenceLine y={20} stroke="#10b981" strokeDasharray="3 3" label="Healthy" />
            <ReferenceLine y={40} stroke="#f59e0b" strokeDasharray="3 3" label="Concern" />
            <ReferenceLine y={60} stroke="#ef4444" strokeDasharray="3 3" label="Critical" />
            <Line
              type="monotone"
              dataKey="depth"
              stroke="#3b82f6"
              strokeWidth={3}
              dot={false}
              name="Depth to Water Table (m)"
            />
          </LineChart>
        </ResponsiveContainer>
      </div>

      {/* Recharge Enhancement Options */}
      <div className="bg-gray-50 p-4 rounded-lg mb-4">
        <h4 className="font-semibold text-sm mb-3">üíß Recharge Enhancement Options:</h4>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
          <div className="bg-white p-3 rounded">
            <strong className="text-green-600">Managed Aquifer Recharge (MAR)</strong>
            <p className="text-gray-600 mt-1">Inject treated surface water during wet periods</p>
          </div>
          <div className="bg-white p-3 rounded">
            <strong className="text-blue-600">Riparian Restoration</strong>
            <p className="text-gray-600 mt-1">Native vegetation increases infiltration</p>
          </div>
          <div className="bg-white p-3 rounded">
            <strong className="text-purple-600">Land Use Change</strong>
            <p className="text-gray-600 mt-1">Reduce impervious surfaces, increase permeability</p>
          </div>
        </div>
      </div>

      {/* Educational Note */}
      <div className="bg-indigo-50 p-4 rounded-lg">
        <p className="text-sm text-gray-700">
          <strong>üí° Systems Thinking:</strong> Aquifers are <em>slow variables</em> in panarchy theory - they operate on
          decadal timescales. This creates a dangerous <em>delay</em>: today's over-pumping won't show effects for years,
          making problems invisible until too late. Notice the <em>stock-flow dynamics</em>: aquifer level (stock) changes
          based on inflow (recharge) minus outflow (pumping). Recovery is asymmetric - depletion happens fast, recovery
          takes decades. This is a classic <em>tragedy of the commons</em> - individual farmers have incentive to pump,
          but collective over-use depletes the shared resource.
        </p>
      </div>
    </div>
  );
};

export default AquiferDrawdownModel;


================================================================================
FILE: components/IrrigationEfficiencyOptimizer.tsx
================================================================================
import React, { useState, useEffect } from 'react';

const IrrigationEfficiencyOptimizer: React.FC = () => {
  const [hectares, setHectares] = useState(100);
  const [currentEfficiency, setCurrentEfficiency] = useState(70);
  const [targetEfficiency, setTargetEfficiency] = useState(85);
  const [results, setResults] = useState<any>(null);

  useEffect(() => {
    calculateSavings();
  }, [hectares, currentEfficiency, targetEfficiency]);

  const calculateSavings = () => {
    const irrigation_hours_per_week = 20;
    const application_rate_mm = 25;

    // Current water use
    const current_applied_mm = application_rate_mm * irrigation_hours_per_week;
    const current_effective_mm = current_applied_mm * (currentEfficiency / 100);

    // Target water use
    const target_applied_mm = current_effective_mm / (targetEfficiency / 100);

    // Savings
    const saved_mm_per_week = current_applied_mm - target_applied_mm;
    const saved_liters_per_week = saved_mm_per_week * hectares * 10000;
    const annual_saved_liters = saved_liters_per_week * 40; // 40 week season

    // Cost savings ($2 per 1000L in NZ)
    const annual_cost_savings = (annual_saved_liters / 1000) * 2;

    // Typical upgrade costs
    const upgrade_cost_per_ha = 5000; // NZD per hectare for modern system
    const total_upgrade_cost = upgrade_cost_per_ha * hectares;
    const payback_years = total_upgrade_cost / annual_cost_savings;

    setResults({
      saved_mm_per_week,
      saved_liters_per_week,
      annual_saved_liters,
      annual_cost_savings,
      total_upgrade_cost,
      payback_years,
      efficiency_gain: targetEfficiency - currentEfficiency
    });
  };

  if (!results) return null;

  return (
    <div className="bg-white rounded-lg shadow-lg p-6">
      <div className="mb-6">
        <h3 className="text-xl font-bold text-gray-800 mb-2">üöú Irrigation Efficiency Optimizer</h3>
        <p className="text-sm text-gray-600">
          Calculate water and cost savings from upgrading irrigation systems. Real NZ agriculture data.
        </p>
      </div>

      {/* Controls */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Farm Size: {hectares} ha
          </label>
          <input
            type="range"
            min="10"
            max="500"
            step="10"
            value={hectares}
            onChange={(e) => setHectares(parseInt(e.target.value))}
            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-green-500"
          />
          <div className="flex justify-between text-xs text-gray-500 mt-1">
            <span>10 ha</span>
            <span>500 ha</span>
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Current Efficiency: {currentEfficiency}%
          </label>
          <input
            type="range"
            min="50"
            max="90"
            step="5"
            value={currentEfficiency}
            onChange={(e) => setCurrentEfficiency(parseInt(e.target.value))}
            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-orange-500"
          />
          <div className="flex justify-between text-xs text-gray-500 mt-1">
            <span>50%</span>
            <span>90%</span>
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Target Efficiency: {targetEfficiency}%
          </label>
          <input
            type="range"
            min="60"
            max="95"
            step="5"
            value={targetEfficiency}
            onChange={(e) => setTargetEfficiency(parseInt(e.target.value))}
            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
          />
          <div className="flex justify-between text-xs text-gray-500 mt-1">
            <span>60%</span>
            <span>95%</span>
          </div>
        </div>
      </div>

      {/* Results Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div className="bg-blue-50 p-4 rounded-lg">
          <div className="text-xs text-gray-600 uppercase font-semibold">Water Saved/Week</div>
          <div className="text-2xl font-bold text-blue-600">
            {(results.saved_liters_per_week / 1000).toFixed(0)}k L
          </div>
          <div className="text-xs text-gray-500 mt-1">{results.saved_mm_per_week.toFixed(1)} mm equivalent</div>
        </div>

        <div className="bg-green-50 p-4 rounded-lg">
          <div className="text-xs text-gray-600 uppercase font-semibold">Annual Savings</div>
          <div className="text-2xl font-bold text-green-600">
            ${results.annual_cost_savings.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}
          </div>
          <div className="text-xs text-gray-500 mt-1">{(results.annual_saved_liters / 1000000).toFixed(1)}M liters saved</div>
        </div>

        <div className="bg-orange-50 p-4 rounded-lg">
          <div className="text-xs text-gray-600 uppercase font-semibold">Upgrade Cost</div>
          <div className="text-2xl font-bold text-orange-600">
            ${results.total_upgrade_cost.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}
          </div>
          <div className="text-xs text-gray-500 mt-1">${(results.total_upgrade_cost / hectares).toFixed(0)}/hectare</div>
        </div>

        <div className={`${results.payback_years <= 5 ? 'bg-green-50' : results.payback_years <= 10 ? 'bg-yellow-50' : 'bg-red-50'} p-4 rounded-lg`}>
          <div className="text-xs text-gray-600 uppercase font-semibold">Payback Period</div>
          <div className={`text-2xl font-bold ${results.payback_years <= 5 ? 'text-green-600' : results.payback_years <= 10 ? 'text-yellow-600' : 'text-red-600'}`}>
            {results.payback_years.toFixed(1)} years
          </div>
          <div className="text-xs text-gray-500 mt-1">
            {results.payback_years <= 5 ? 'Excellent ROI' : results.payback_years <= 10 ? 'Good ROI' : 'Long payback'}
          </div>
        </div>
      </div>

      {/* Efficiency Comparison Bars */}
      <div className="mb-6">
        <h4 className="text-sm font-semibold mb-3">Efficiency Comparison</h4>
        <div className="space-y-3">
          <div>
            <div className="flex justify-between text-sm mb-1">
              <span>Current System</span>
              <span className="font-semibold">{currentEfficiency}%</span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-4">
              <div
                className="bg-orange-500 h-4 rounded-full transition-all duration-300"
                style={{ width: `${currentEfficiency}%` }}
              />
            </div>
          </div>

          <div>
            <div className="flex justify-between text-sm mb-1">
              <span>Target System</span>
              <span className="font-semibold text-green-600">{targetEfficiency}%</span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-4">
              <div
                className="bg-green-500 h-4 rounded-full transition-all duration-300"
                style={{ width: `${targetEfficiency}%` }}
              />
            </div>
          </div>

          <div className="text-center text-sm text-gray-600 pt-2">
            <strong className="text-blue-600">+{results.efficiency_gain}%</strong> efficiency gain
          </div>
        </div>
      </div>

      {/* Technology Options */}
      <div className="bg-gray-50 p-4 rounded-lg mb-4">
        <h4 className="font-semibold text-sm mb-3">Irrigation Technology Guide:</h4>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-3 text-xs">
          <div className="bg-white p-3 rounded">
            <strong className="text-orange-600">Border Dyke (60-70%)</strong>
            <p className="text-gray-600 mt-1">Traditional flooding method, lowest efficiency</p>
          </div>
          <div className="bg-white p-3 rounded">
            <strong className="text-yellow-600">Centre Pivot (75-85%)</strong>
            <p className="text-gray-600 mt-1">Good coverage, moderate efficiency</p>
          </div>
          <div className="bg-white p-3 rounded">
            <strong className="text-green-600">Drip/Micro (85-95%)</strong>
            <p className="text-gray-600 mt-1">Highest efficiency, targeted delivery</p>
          </div>
        </div>
      </div>

      {/* Educational Note */}
      <div className="bg-purple-50 p-4 rounded-lg">
        <p className="text-sm text-gray-700">
          <strong>üí° Systems Thinking:</strong> This is a <em>leverage point</em> in the drought system - small changes in irrigation
          efficiency have cascading effects. More efficient irrigation means less water demand, which reduces pressure on aquifers,
          which improves resilience. Notice the <em>investment threshold</em> - systems with good ROI (payback &lt;5 years) are
          economically viable, creating a positive feedback loop where water savings fund further improvements.
        </p>
      </div>
    </div>
  );
};

export default IrrigationEfficiencyOptimizer;


================================================================================
FILE: components/PanarchyNestVisualizer.tsx
================================================================================
import React, { useState } from 'react';

interface PanarchyScale {
  name: string;
  speed: string;
  timeScale: string;
  examples: string[];
  variables: string[];
  color: string;
}

const PanarchyNestVisualizer: React.FC = () => {
  const [selectedScale, setSelectedScale] = useState<number>(1);

  const scales: PanarchyScale[] = [
    {
      name: 'Farm (Fast)',
      speed: 'Hours to Days',
      timeScale: 'Daily Decisions',
      examples: [
        'Check soil moisture',
        'Turn on irrigation',
        'Move stock between paddocks',
        'Daily weather checks'
      ],
      variables: ['Soil Moisture', 'Daily Rainfall', 'Pasture Cover', 'Stock Water Needs'],
      color: '#10b981' // green
    },
    {
      name: 'Regional (Medium)',
      speed: 'Weeks to Months',
      timeScale: 'Seasonal Management',
      examples: [
        'Council water restrictions',
        'Dam level monitoring',
        'Regional drought declarations',
        'Community water allocation'
      ],
      variables: ['Dam Levels', 'River Flows', 'Aquifer Recharge', 'Regional Rainfall'],
      color: '#3b82f6' // blue
    },
    {
      name: 'National (Slow)',
      speed: 'Years to Decades',
      timeScale: 'Policy & Climate',
      examples: [
        'Climate change adaptation',
        'Water allocation frameworks',
        'Infrastructure investment',
        'Land use change'
      ],
      variables: ['Aquifer Capacity', 'Climate Trends', 'Policy Frameworks', 'Infrastructure'],
      color: '#8b5cf6' // purple
    }
  ];

  const current = scales[selectedScale];

  return (
    <div className="bg-white rounded-lg shadow-lg p-6">
      <div className="mb-6">
        <h3 className="text-xl font-bold text-gray-800 mb-2">üåÄ Panarchy: Nested Adaptive Cycles</h3>
        <p className="text-sm text-gray-600">
          Drought systems operate at multiple nested scales - fast farm decisions embedded in slower regional/national cycles.
        </p>
      </div>

      {/* Nested Circles Visualization */}
      <div className="flex justify-center mb-8">
        <div className="relative w-80 h-80">
          {/* Outer Circle - National */}
          <div
            onClick={() => setSelectedScale(2)}
            className={`absolute inset-0 rounded-full border-8 flex items-center justify-center cursor-pointer transition-all ${
              selectedScale === 2 ? 'border-purple-500 bg-purple-50' : 'border-purple-300 bg-white hover:bg-purple-50'
            }`}
            style={{ animation: 'spin 60s linear infinite' }}
          >
            <span className={`text-sm font-semibold ${selectedScale === 2 ? 'text-purple-700' : 'text-purple-500'}`}>
              National (Slow)
            </span>

            {/* Middle Circle - Regional */}
            <div
              onClick={(e) => { e.stopPropagation(); setSelectedScale(1); }}
              className={`absolute inset-12 rounded-full border-8 flex items-center justify-center cursor-pointer transition-all ${
                selectedScale === 1 ? 'border-blue-500 bg-blue-50' : 'border-blue-300 bg-white hover:bg-blue-50'
              }`}
              style={{ animation: 'spin 30s linear infinite' }}
            >
              <span className={`text-sm font-semibold ${selectedScale === 1 ? 'text-blue-700' : 'text-blue-500'}`}>
                Regional (Medium)
              </span>

              {/* Inner Circle - Farm */}
              <div
                onClick={(e) => { e.stopPropagation(); setSelectedScale(0); }}
                className={`absolute inset-12 rounded-full border-8 flex items-center justify-center cursor-pointer transition-all ${
                  selectedScale === 0 ? 'border-green-500 bg-green-50' : 'border-green-300 bg-white hover:bg-green-50'
                }`}
                style={{ animation: 'spin 10s linear infinite' }}
              >
                <span className={`text-sm font-semibold ${selectedScale === 0 ? 'text-green-700' : 'text-green-500'}`}>
                  Farm (Fast)
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* Selected Scale Details */}
      <div className={`border-4 rounded-lg p-6 mb-6`} style={{ borderColor: current.color }}>
        <div className="flex items-center justify-between mb-4">
          <h4 className="text-lg font-bold" style={{ color: current.color }}>{current.name}</h4>
          <div className="text-right">
            <div className="text-xs text-gray-600">Time Scale</div>
            <div className="text-sm font-semibold">{current.speed}</div>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h5 className="text-sm font-semibold text-gray-700 mb-2">Key Variables:</h5>
            <ul className="space-y-1">
              {current.variables.map((variable, idx) => (
                <li key={idx} className="text-sm text-gray-600 flex items-start">
                  <span className="text-xl mr-2">‚Ä¢</span>
                  <span>{variable}</span>
                </li>
              ))}
            </ul>
          </div>

          <div>
            <h5 className="text-sm font-semibold text-gray-700 mb-2">Example Activities:</h5>
            <ul className="space-y-1">
              {current.examples.map((example, idx) => (
                <li key={idx} className="text-sm text-gray-600 flex items-start">
                  <span className="text-xl mr-2">‚Üí</span>
                  <span>{example}</span>
                </li>
              ))}
            </ul>
          </div>
        </div>
      </div>

      {/* Cross-Scale Effects */}
      <div className="bg-gradient-to-r from-green-50 via-blue-50 to-purple-50 p-4 rounded-lg mb-4">
        <h4 className="font-semibold text-sm mb-3">üîÑ Cross-Scale Dynamics:</h4>
        <div className="space-y-2 text-sm text-gray-700">
          <div className="flex items-start">
            <span className="text-green-500 font-bold mr-2">‚Üó</span>
            <span><strong>Revolts (Fast ‚Üí Slow):</strong> Farm-level drought stress aggregates to trigger regional restrictions,
              which can influence national policy changes.</span>
          </div>
          <div className="flex items-start">
            <span className="text-purple-500 font-bold mr-2">‚Üò</span>
            <span><strong>Remembers (Slow ‚Üí Fast):</strong> National water allocation frameworks and aquifer capacity
              constrain regional policy options, which limit farm choices.</span>
          </div>
        </div>
      </div>

      {/* Adaptive Cycle Phases */}
      <div className="bg-gray-50 p-4 rounded-lg mb-4">
        <h4 className="font-semibold text-sm mb-3">‚ôªÔ∏è Adaptive Cycle Phases (all scales):</h4>
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
          <div className="bg-white p-3 rounded">
            <div className="font-bold text-green-600">Growth (r)</div>
            <div className="text-gray-600 mt-1">Resource accumulation, expansion</div>
          </div>
          <div className="bg-white p-3 rounded">
            <div className="font-bold text-blue-600">Conservation (K)</div>
            <div className="text-gray-600 mt-1">Stability, optimization, rigidity</div>
          </div>
          <div className="bg-white p-3 rounded">
            <div className="font-bold text-orange-600">Release (Œ©)</div>
            <div className="text-gray-600 mt-1">Collapse, disruption, crisis</div>
          </div>
          <div className="bg-white p-3 rounded">
            <div className="font-bold text-purple-600">Reorganization (Œ±)</div>
            <div className="text-gray-600 mt-1">Innovation, adaptation, renewal</div>
          </div>
        </div>
      </div>

      {/* Educational Note */}
      <div className="bg-yellow-50 p-4 rounded-lg">
        <p className="text-sm text-gray-700">
          <strong>üí° Systems Thinking:</strong> <em>Panarchy</em> (Holling & Gunderson) shows how systems at different
          speeds interact. Fast variables (daily soil moisture) are constrained by slow variables (aquifer levels). But fast
          changes can also cascade upward - many farms in crisis triggers regional response. Understanding these nested cycles
          helps target interventions: farm-level efficiency (fast), regional restrictions (medium), or infrastructure investment (slow).
          All three scales must be addressed for resilience.
        </p>
      </div>

      <style>{`
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
      `}</style>
    </div>
  );
};

export default PanarchyNestVisualizer;


================================================================================
FILE: components/RainfallExplorer.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ReferenceLine } from 'recharts';
import { DroughtRiskData } from '../types';

interface RainfallExplorerProps {
  initialRisk?: number;
  regionName?: string;
}

const RainfallExplorer: React.FC<RainfallExplorerProps> = ({ initialRisk = 42, regionName = "Taranaki" }) => {
  const [weeklyRainfall, setWeeklyRainfall] = useState<number>(10); // Default 10mm/week
  const [projectionData, setProjectionData] = useState<any[]>([]);

  // Constants for the simulation
  const DAYS_TO_PROJECT = 30;
  const DAILY_EVAPORATION = 3.5; // mm/day (Typical summer demand)
  const CRITICAL_THRESHOLD = 80; // Risk score where it becomes critical
  const RECOVERY_THRESHOLD = 20; // Risk score where it is considered recovered

  useEffect(() => {
    calculateProjection();
  }, [weeklyRainfall, initialRisk]);

  const calculateProjection = () => {
    const data = [];
    let currentRisk = initialRisk;
    const dailyRainfall = weeklyRainfall / 7;
    
    // Sensitivity: How much risk score changes per mm of deficit/surplus
    // Arbitrary scaling factor to make the game playable/realistic
    // If deficit is 3.5mm/day (0 rain), risk should rise significantly over 30 days.
    // Say +1.5 risk points per mm of deficit.
    const RISK_SENSITIVITY = 1.5;

    for (let day = 0; day <= DAYS_TO_PROJECT; day++) {
      data.push({
        day: `Day ${day}`,
        risk: Math.round(currentRisk * 10) / 10,
        threshold: CRITICAL_THRESHOLD
      });

      const dailyDeficit = DAILY_EVAPORATION - dailyRainfall;
      
      // Update risk
      // If deficit > 0 (drying), risk goes up.
      // If deficit < 0 (wetting), risk goes down.
      currentRisk += dailyDeficit * RISK_SENSITIVITY;

      // Clamp risk between 0 and 100
      currentRisk = Math.max(0, Math.min(100, currentRisk));
    }

    setProjectionData(data);
  };

  const getRiskColor = (risk: number) => {
    if (risk >= 80) return '#ef4444'; // Red
    if (risk >= 50) return '#f97316'; // Orange
    if (risk >= 20) return '#eab308'; // Yellow
    return '#22c55e'; // Green
  };

  const finalRisk = projectionData.length > 0 ? projectionData[projectionData.length - 1].risk : initialRisk;
  const isCritical = finalRisk >= CRITICAL_THRESHOLD;
  const isSafe = finalRisk <= RECOVERY_THRESHOLD;

  return (
    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
      <div className="mb-6">
        <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
          <span className="text-2xl">üåßÔ∏è</span> Rainfall Scenario Explorer
        </h2>
        <p className="text-slate-500 text-sm mt-1">
          Project drought risk for <strong>{regionName}</strong> over the next 30 days based on rainfall scenarios.
        </p>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        {/* Controls */}
        <div className="lg:col-span-1 space-y-6">
          <div className="bg-slate-50 p-5 rounded-lg border border-slate-100">
            <label className="block text-sm font-medium text-slate-700 mb-2">
              Weekly Rainfall Scenario
            </label>
            <div className="flex items-center gap-4 mb-2">
              <input
                type="range"
                min="0"
                max="50"
                step="1"
                value={weeklyRainfall}
                onChange={(e) => setWeeklyRainfall(parseInt(e.target.value))}
                className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
              />
              <span className="text-lg font-bold text-blue-600 w-16 text-right">
                {weeklyRainfall}mm
              </span>
            </div>
            <p className="text-xs text-slate-500">
              Adjust to simulate dry spells (0-10mm) or recovery rains (30mm+).
            </p>
          </div>

          <div className="bg-blue-50 p-5 rounded-lg border border-blue-100">
            <h3 className="font-semibold text-blue-900 mb-2">Analysis</h3>
            <div className="space-y-3 text-sm">
              <div className="flex justify-between">
                <span className="text-blue-700">Daily Demand (Evap):</span>
                <span className="font-medium text-blue-900">{DAILY_EVAPORATION} mm/day</span>
              </div>
              <div className="flex justify-between">
                <span className="text-blue-700">Scenario Supply:</span>
                <span className="font-medium text-blue-900">{(weeklyRainfall / 7).toFixed(1)} mm/day</span>
              </div>
              <div className="pt-2 border-t border-blue-200 flex justify-between font-bold">
                <span className="text-blue-800">Net Balance:</span>
                <span className={`${(weeklyRainfall / 7) - DAILY_EVAPORATION >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                  {((weeklyRainfall / 7) - DAILY_EVAPORATION).toFixed(1)} mm/day
                </span>
              </div>
            </div>
          </div>

          <div className={`p-4 rounded-lg border ${isCritical ? 'bg-red-50 border-red-100' : isSafe ? 'bg-green-50 border-green-100' : 'bg-orange-50 border-orange-100'}`}>
            <h4 className={`font-bold ${isCritical ? 'text-red-800' : isSafe ? 'text-green-800' : 'text-orange-800'}`}>
              {isCritical ? 'CRITICAL RISK' : isSafe ? 'RECOVERY LIKELY' : 'CAUTION NEEDED'}
            </h4>
            <p className={`text-sm mt-1 ${isCritical ? 'text-red-700' : isSafe ? 'text-green-700' : 'text-orange-700'}`}>
              {isCritical 
                ? `At ${weeklyRainfall}mm/week, risk hits critical levels.` 
                : isSafe 
                  ? `At ${weeklyRainfall}mm/week, the region recovers.` 
                  : `Risk remains elevated. Need >${Math.ceil(DAILY_EVAPORATION * 7)}mm/week to improve.`}
            </p>
          </div>
        </div>

        {/* Chart */}
        <div className="lg:col-span-2 h-[350px] bg-white rounded-lg border border-slate-100 p-4">
          <ResponsiveContainer width="100%" height="100%">
            <LineChart data={projectionData} margin={{ top: 5, right: 20, bottom: 5, left: 0 }}>
              <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
              <XAxis 
                dataKey="day" 
                tick={{ fontSize: 12 }} 
                interval={6}
                stroke="#94a3b8"
              />
              <YAxis 
                domain={[0, 100]} 
                label={{ value: 'Drought Risk Score', angle: -90, position: 'insideLeft', style: { textAnchor: 'middle', fill: '#64748b' } }}
                tick={{ fontSize: 12 }}
                stroke="#94a3b8"
              />
              <Tooltip 
                contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}
              />
              <ReferenceLine y={CRITICAL_THRESHOLD} label="Critical" stroke="red" strokeDasharray="3 3" />
              <Legend />
              <Line 
                type="monotone" 
                dataKey="risk" 
                name="Projected Risk" 
                stroke="#2563eb" 
                strokeWidth={3}
                dot={false}
                activeDot={{ r: 6 }}
              />
            </LineChart>
          </ResponsiveContainer>
        </div>
      </div>
    </div>
  );
};

export default RainfallExplorer;


================================================================================
FILE: components/SoilMoistureSimulator.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ReferenceLine, ResponsiveContainer } from 'recharts';

const SoilMoistureSimulator: React.FC = () => {
  const [temperature, setTemperature] = useState(20);
  const [humidity, setHumidity] = useState(60);
  const [data, setData] = useState<any[]>([]);
  const [criticalDay, setCriticalDay] = useState<number | null>(null);

  useEffect(() => {
    calculateSimulation();
  }, [temperature, humidity]);

  const calculateSimulation = () => {
    const initial_moisture = 70;
    let current_moisture = initial_moisture;
    const results = [];
    let critical_day_found = null;

    for (let day = 0; day <= 30; day++) {
      // Simplified ET calculation
      const humidity_deficit = Math.max(0, 80 - humidity) / 100;
      const temp_factor = Math.max(0, temperature - 10) / 30;
      const et_rate_mm = 2 + (temp_factor * 4) + (humidity_deficit * 3);
      const moisture_loss_pct = (et_rate_mm / 150) * 100;

      let status = 'optimal';
      if (current_moisture <= 20) {
        status = 'critical';
        if (critical_day_found === null) {
          critical_day_found = day;
        }
      } else if (current_moisture <= 40) {
        status = 'stress';
      } else if (current_moisture <= 60) {
        status = 'adequate';
      }

      results.push({
        day,
        moisture: Math.max(0, Math.round(current_moisture * 10) / 10),
        status
      });

      current_moisture -= moisture_loss_pct;
    }

    setData(results);
    setCriticalDay(critical_day_found);
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'optimal': return '#10b981'; // green
      case 'adequate': return '#3b82f6'; // blue
      case 'stress': return '#f59e0b'; // orange
      case 'critical': return '#ef4444'; // red
      default: return '#gray';
    }
  };

  return (
    <div className="bg-white rounded-lg shadow-lg p-6">
      <div className="mb-6">
        <h3 className="text-xl font-bold text-gray-800 mb-2">üå± Soil Moisture Decay Simulator</h3>
        <p className="text-sm text-gray-600">
          Explore how temperature and humidity affect soil moisture over time. Based on simplified Penman-Monteith evapotranspiration model.
        </p>
      </div>

      {/* Controls */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Temperature: {temperature}¬∞C
          </label>
          <input
            type="range"
            min="10"
            max="35"
            value={temperature}
            onChange={(e) => setTemperature(parseInt(e.target.value))}
            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-orange-500"
          />
          <div className="flex justify-between text-xs text-gray-500 mt-1">
            <span>10¬∞C</span>
            <span>35¬∞C</span>
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Humidity: {humidity}%
          </label>
          <input
            type="range"
            min="20"
            max="90"
            value={humidity}
            onChange={(e) => setHumidity(parseInt(e.target.value))}
            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
          />
          <div className="flex justify-between text-xs text-gray-500 mt-1">
            <span>20%</span>
            <span>90%</span>
          </div>
        </div>
      </div>

      {/* Alert */}
      {criticalDay !== null && (
        <div className="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
          <div className="flex">
            <div className="flex-shrink-0">
              <svg className="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
              </svg>
            </div>
            <div className="ml-3">
              <p className="text-sm text-red-700">
                <strong>Critical threshold reached in {criticalDay} days</strong> - Soil moisture drops below 20% (crop stress level)
              </p>
            </div>
          </div>
        </div>
      )}

      {/* Chart */}
      <div className="h-80 mb-6">
        <ResponsiveContainer width="100%" height="100%">
          <LineChart data={data}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis
              dataKey="day"
              label={{ value: 'Days', position: 'insideBottom', offset: -5 }}
            />
            <YAxis
              label={{ value: 'Soil Moisture (%)', angle: -90, position: 'insideLeft' }}
              domain={[0, 100]}
            />
            <Tooltip
              content={({ active, payload }) => {
                if (active && payload && payload.length) {
                  const data = payload[0].payload;
                  return (
                    <div className="bg-white p-3 border border-gray-200 rounded shadow">
                      <p className="text-sm font-semibold">Day {data.day}</p>
                      <p className="text-sm">Moisture: {data.moisture}%</p>
                      <p className="text-sm capitalize" style={{ color: getStatusColor(data.status) }}>
                        Status: {data.status}
                      </p>
                    </div>
                  );
                }
                return null;
              }}
            />
            <Legend />
            <ReferenceLine y={60} stroke="#10b981" strokeDasharray="3 3" label="Optimal" />
            <ReferenceLine y={40} stroke="#f59e0b" strokeDasharray="3 3" label="Stress" />
            <ReferenceLine y={20} stroke="#ef4444" strokeDasharray="3 3" label="Critical" />
            <Line
              type="monotone"
              dataKey="moisture"
              stroke="#3b82f6"
              strokeWidth={3}
              dot={false}
              name="Soil Moisture %"
            />
          </LineChart>
        </ResponsiveContainer>
      </div>

      {/* Legend */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
        <div className="flex items-center gap-2">
          <div className="w-3 h-3 rounded-full bg-green-500"></div>
          <span>Optimal (&gt;60%)</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-3 h-3 rounded-full bg-blue-500"></div>
          <span>Adequate (40-60%)</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-3 h-3 rounded-full bg-orange-500"></div>
          <span>Stress (20-40%)</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-3 h-3 rounded-full bg-red-500"></div>
          <span>Critical (&lt;20%)</span>
        </div>
      </div>

      {/* Educational Note */}
      <div className="mt-6 bg-blue-50 p-4 rounded-lg">
        <p className="text-sm text-gray-700">
          <strong>üí° Systems Thinking:</strong> This model shows the <em>feedback loop</em> between weather conditions and soil moisture.
          High temperature + low humidity = faster moisture loss. Notice how the system can cross critical thresholds
          even with gradual changes. This is a <em>threshold effect</em> - behavior changes dramatically at 20% moisture.
        </p>
      </div>
    </div>
  );
};

export default SoilMoistureSimulator;


================================================================================
FILE: components/TRCMap.tsx
================================================================================
import React, { useEffect, useState } from 'react';
import { Link } from 'react-router-dom';
import { MapContainer, TileLayer, Marker, Popup, Polygon } from 'react-leaflet';
import L from 'leaflet';
import taranakiGeoJSON from '../data/taranaki.json';
import { API_BASE_URL } from '../constants';

// Fix for default Leaflet icons in React
import icon from 'leaflet/dist/images/marker-icon.png';
import iconShadow from 'leaflet/dist/images/marker-shadow.png';

// Map Configuration
const TARANAKI_CENTER: [number, number] = [-39.3, 174.1];
const TARANAKI_BOUNDS: [[number, number], [number, number]] = [
  [-39.95, 173.2],  // Southwest corner
  [-38.65, 175.3]   // Northeast corner
];
const DEFAULT_ZOOM = 10;

let DefaultIcon = L.icon({
    iconUrl: icon,
    shadowUrl: iconShadow,
    iconSize: [25, 41],
    iconAnchor: [12, 41]
});

L.Marker.prototype.options.icon = DefaultIcon;

interface Site {
  name: string;
  latitude: number;
  longitude: number;
  region: string;
}

// Helper to parse WaterML2 response
const parseWaterML2 = (xmlText: string) => {
  const parser = new DOMParser();
  const xmlDoc = parser.parseFromString(xmlText, "text/xml");
  
  const points: { time: string; value: number }[] = [];
  const measurements = xmlDoc.getElementsByTagName("wml2:MeasurementTVP");
  
  for (let i = 0; i < measurements.length; i++) {
    const timeElem = measurements[i].getElementsByTagName("wml2:time")[0];
    const valueElem = measurements[i].getElementsByTagName("wml2:value")[0];
    if (timeElem && valueElem) {
      points.push({
        time: timeElem.textContent || "",
        value: parseFloat(valueElem.textContent || "0")
      });
    }
  }
  
  // Try to find units
  let units = "";
  const uomElem = xmlDoc.getElementsByTagName("wml2:uom")[0];
  if (uomElem) {
    units = uomElem.getAttribute("code") || "";
  }
  
  return { points, units };
};

const SitePopup: React.FC<{ site: Site }> = ({ site }) => {
  const [popupData, setPopupData] = useState<{ value?: string; units?: string; time?: string; error?: string } | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchData = async () => {
      setLoading(true);

      // Helper to fetch specific property via backend proxy (avoids CORS)
      const fetchProperty = async (property: string) => {
        const url = `${API_BASE_URL}/api/public/hilltop/data?site=${encodeURIComponent(site.name)}&measurement=${encodeURIComponent(property)}&days=1`;

        const response = await fetch(url);
        if (!response.ok) throw new Error("Network response was not ok");
        return await response.json();
      };

      try {
        // Try Flow first
        let data = await fetchProperty("Flow");

        // If no flow data, try Rainfall
        if (!data.data || data.data.length === 0) {
           data = await fetchProperty("Rainfall");
        }

        if (data.data && data.data.length > 0) {
          const latest = data.data[data.data.length - 1];
          setPopupData({
            value: latest.value.toFixed(3),
            units: data.units || '',
            time: new Date(latest.timestamp).toLocaleString('en-NZ')
          });
        } else {
          setPopupData({ error: "No recent data available" });
        }
      } catch (error) {
        console.error("Error fetching SOS data:", error);
        setPopupData({ error: "Failed to fetch data" });
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [site.name]);

  return (
    <div className="min-w-[250px]">
      <h3 className="font-bold text-lg border-b pb-1 mb-2">{site.name}</h3>
      
      {loading ? (
        <div className="text-sm text-slate-500">Loading live data...</div>
      ) : popupData?.error ? (
        <div className="text-sm text-red-500">{popupData.error}</div>
      ) : popupData ? (
        <div className="bg-slate-50 p-2 rounded border">
          <div className="text-xs text-slate-500 mb-1">Latest Reading</div>
          <div className="text-2xl font-bold text-blue-600">
            {popupData.value} 
            <span className="text-sm font-normal text-slate-600 ml-1">{popupData.units}</span>
          </div>
          <div className="text-[10px] text-slate-400 mt-1">
            {popupData.time}
          </div>
        </div>
      ) : null}
    </div>
  );
};

const TRCMap: React.FC = () => {
  const [sites, setSites] = useState<Site[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchSites = async () => {
      try {
        const response = await fetch(`${API_BASE_URL}/api/public/hilltop/sites`);
        if (!response.ok) throw new Error('Failed to fetch sites');
        const data = await response.json();
        setSites(data.sites);
        setLoading(false);
      } catch (err) {
        setError(err instanceof Error ? err.message : 'Unknown error');
        setLoading(false);
      }
    };

    fetchSites();
  }, []);

  // Taranaki Polygon coordinates (lat, lon) - reversed from GeoJSON (lon, lat)
  const taranakiBoundary = taranakiGeoJSON.features[0].geometry.coordinates[0].map(
    coord => [coord[1], coord[0]] as [number, number]
  );

  if (loading) return <div className="p-8 text-center text-slate-500">Loading Map Data...</div>;
  if (error) return <div className="p-8 text-center text-red-500">Error loading map: {error}</div>;

  return (
    <div className="h-screen w-full flex flex-col">
      <div className="bg-white p-4 shadow-sm z-10 flex justify-between items-center">
        <div className="flex items-center gap-4">
          <Link to="/" className="p-2 hover:bg-slate-100 rounded-full transition-colors" title="Back to Dashboard">
            <svg className="w-6 h-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
          </Link>
          <div>
            <h1 className="text-xl font-bold text-slate-800">Taranaki Environmental Monitoring</h1>
            <p className="text-sm text-slate-500">Real-time data from {sites.length} TRC Hilltop sites</p>
          </div>
        </div>
        <div className="text-xs text-slate-400">
          Click a marker to view live telemetry
        </div>
      </div>
      
      <div className="flex-1 relative" style={{ height: 'calc(100vh - 80px)', zIndex: 0 }}>
        <MapContainer
          center={TARANAKI_CENTER}
          zoom={DEFAULT_ZOOM}
          maxBounds={TARANAKI_BOUNDS}
          maxBoundsViscosity={1.0}
          minZoom={9}
          maxZoom={15}
          scrollWheelZoom={false}
          style={{ height: '100%', width: '100%' }}
          whenReady={(map) => {
            setTimeout(() => {
                map.target.invalidateSize();
            }, 100);
          }}
        >
          <TileLayer
            attribution='&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"
          />
          
          {/* Taranaki Region Overlay */}
          <Polygon 
            positions={taranakiBoundary}
            pathOptions={{ color: '#f59e0b', fillColor: '#f59e0b', fillOpacity: 0.1, weight: 2 }} 
          />

          {sites.map((site, idx) => (
            <Marker key={idx} position={[site.latitude, site.longitude]}>
              <Popup autoPan={false} className="leaflet-popup-high-z">
                <SitePopup site={site} />
              </Popup>
            </Marker>
          ))}
        </MapContainer>
      </div>
    </div>
  );
};

export default TRCMap;


================================================================================
FILE: components/TriggersSkeleton.tsx
================================================================================
import React from 'react';

const TriggersSkeleton: React.FC = () => {
  return (
    <div className="space-y-4">
      {/* Skeleton Card 1 */}
      <div className="bg-white rounded-xl p-6 border border-slate-200 shadow-sm animate-pulse">
        <div className="flex items-start justify-between mb-4">
          <div className="flex-1">
            <div className="h-5 bg-slate-200 rounded w-48 mb-2"></div>
            <div className="h-4 bg-slate-100 rounded w-32"></div>
          </div>
          <div className="h-6 w-16 bg-slate-200 rounded-full"></div>
        </div>
        <div className="grid grid-cols-2 gap-4 mb-4">
          <div className="h-4 bg-slate-100 rounded"></div>
          <div className="h-4 bg-slate-100 rounded"></div>
        </div>
        <div className="flex gap-2">
          <div className="h-8 w-20 bg-slate-200 rounded"></div>
          <div className="h-8 w-20 bg-slate-200 rounded"></div>
        </div>
      </div>

      {/* Skeleton Card 2 */}
      <div className="bg-white rounded-xl p-6 border border-slate-200 shadow-sm animate-pulse">
        <div className="flex items-start justify-between mb-4">
          <div className="flex-1">
            <div className="h-5 bg-slate-200 rounded w-48 mb-2"></div>
            <div className="h-4 bg-slate-100 rounded w-32"></div>
          </div>
          <div className="h-6 w-16 bg-slate-200 rounded-full"></div>
        </div>
        <div className="grid grid-cols-2 gap-4 mb-4">
          <div className="h-4 bg-slate-100 rounded"></div>
          <div className="h-4 bg-slate-100 rounded"></div>
        </div>
        <div className="flex gap-2">
          <div className="h-8 w-20 bg-slate-200 rounded"></div>
          <div className="h-8 w-20 bg-slate-200 rounded"></div>
        </div>
      </div>

      {/* Skeleton Card 3 */}
      <div className="bg-white rounded-xl p-6 border border-slate-200 shadow-sm animate-pulse">
        <div className="flex items-start justify-between mb-4">
          <div className="flex-1">
            <div className="h-5 bg-slate-200 rounded w-48 mb-2"></div>
            <div className="h-4 bg-slate-100 rounded w-32"></div>
          </div>
          <div className="h-6 w-16 bg-slate-200 rounded-full"></div>
        </div>
        <div className="grid grid-cols-2 gap-4 mb-4">
          <div className="h-4 bg-slate-100 rounded"></div>
          <div className="h-4 bg-slate-100 rounded"></div>
        </div>
        <div className="flex gap-2">
          <div className="h-8 w-20 bg-slate-200 rounded"></div>
          <div className="h-8 w-20 bg-slate-200 rounded"></div>
        </div>
      </div>
    </div>
  );
};

export default TriggersSkeleton;


================================================================================
FILE: components/UserSelector.tsx
================================================================================
import React, { useState } from 'react';
import { User } from '../types';

interface UserSelectorProps {
  onUserChange: (user: User) => void;
  selectedUser: User | null;
}

// Mock users for the MVP
const MOCK_USERS: User[] = [
  {
    id: 'user_1',
    name: 'Regan',
    email: 'regan@axiomintelligence.co.nz',
    organization: 'Axiom Intelligence',
    region: 'Auckland',
  },
  {
    id: 'user_2',
    name: 'Tim House',
    email: 'tim.house@fonterra.com',
    organization: 'Fonterra',
    region: 'Taranaki',
  },
];

const UserSelector: React.FC<UserSelectorProps> = ({ onUserChange, selectedUser }) => {
  const [isOpen, setIsOpen] = useState(false);

  const handleUserSelect = (user: User) => {
    onUserChange(user);
    setIsOpen(false);
  };

  return (
    <div className="relative">
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="w-full flex items-center justify-between px-4 py-3 bg-white border border-slate-200 rounded-lg shadow-sm hover:bg-slate-50 transition-colors"
      >
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-semibold">
            {selectedUser ? selectedUser.name.charAt(0).toUpperCase() : 'U'}
          </div>
          <div className="text-left">
            {selectedUser ? (
              <>
                <div className="text-sm font-semibold text-slate-900">{selectedUser.name}</div>
                <div className="text-xs text-slate-500">{selectedUser.email}</div>
              </>
            ) : (
              <div className="text-sm text-slate-500">Select a user</div>
            )}
          </div>
        </div>
        <svg
          className={`w-5 h-5 text-slate-400 transition-transform ${isOpen ? 'rotate-180' : ''}`}
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      {isOpen && (
        <>
          {/* Backdrop */}
          <div
            className="fixed inset-0 z-10"
            onClick={() => setIsOpen(false)}
          />

          {/* Dropdown Menu */}
          <div className="absolute top-full left-0 right-0 mt-2 bg-white border border-slate-200 rounded-lg shadow-lg z-20 overflow-hidden">
            {MOCK_USERS.map((user) => (
              <button
                key={user.id}
                onClick={() => handleUserSelect(user)}
                className={`w-full px-4 py-3 text-left hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-b-0 ${
                  selectedUser?.id === user.id ? 'bg-blue-50' : ''
                }`}
              >
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center text-white font-semibold">
                    {user.name.charAt(0).toUpperCase()}
                  </div>
                  <div className="flex-1">
                    <div className="text-sm font-semibold text-slate-900">{user.name}</div>
                    <div className="text-xs text-slate-500">{user.email}</div>
                    <div className="text-xs text-slate-400 mt-1">
                      {user.organization} ‚Ä¢ {user.region}
                    </div>
                  </div>
                  {selectedUser?.id === user.id && (
                    <svg
                      className="w-5 h-5 text-blue-600"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={2}
                        d="M5 13l4 4L19 7"
                      />
                    </svg>
                  )}
                </div>
              </button>
            ))}
          </div>
        </>
      )}

      {/* User Info Display (when selected) */}
      {selectedUser && (
        <div className="mt-3 p-3 bg-slate-50 rounded-lg border border-slate-200">
          <div className="grid grid-cols-2 gap-2 text-xs">
            <div>
              <span className="text-slate-500 font-medium">Organization:</span>
              <div className="text-slate-900 font-semibold">{selectedUser.organization}</div>
            </div>
            <div>
              <span className="text-slate-500 font-medium">Primary Region:</span>
              <div className="text-slate-900 font-semibold">{selectedUser.region}</div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default UserSelector;


================================================================================
FILE: components/WaterRestrictionCalculator.tsx
================================================================================
import React, { useState, useEffect } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ReferenceLine, ResponsiveContainer } from 'recharts';

const WaterRestrictionCalculator: React.FC = () => {
  const [restrictionLevel, setRestrictionLevel] = useState(0);
  const [currentDamLevel, setCurrentDamLevel] = useState(60);
  const [data, setData] = useState<any[]>([]);

  const restrictionLabels = [
    { level: 0, name: 'No Restrictions', color: 'green', reduction: 0 },
    { level: 1, name: 'Voluntary Conservation', color: 'blue', reduction: 10 },
    { level: 2, name: 'Sprinkler Ban', color: 'yellow', reduction: 25 },
    { level: 3, name: 'Outdoor Ban', color: 'orange', reduction: 40 },
    { level: 4, name: 'Essential Only', color: 'red', reduction: 55 }
  ];

  useEffect(() => {
    calculateProjection();
  }, [restrictionLevel, currentDamLevel]);

  const calculateProjection = () => {
    const results = [];
    let dam_level = currentDamLevel;

    // Usage rates (ML/day)
    const baseline_usage = 100;
    const reduction_factors = [1.0, 0.9, 0.75, 0.6, 0.45];
    const daily_usage = baseline_usage * reduction_factors[restrictionLevel];

    // Minimal summer inflow
    const daily_inflow = 20;
    const net_change_ML = daily_inflow - daily_usage;

    // Dam capacity
    const capacity_ML = 10000;

    for (let day = 0; day <= 90; day++) {
      let status = 'healthy';
      if (dam_level <= 30) status = 'critical';
      else if (dam_level <= 50) status = 'concern';
      else if (dam_level <= 70) status = 'watch';

      results.push({
        day,
        dam_level: Math.max(0, Math.round(dam_level * 10) / 10),
        usage: Math.round(daily_usage * 10) / 10,
        status
      });

      // Update for next day
      const current_level_ML = (dam_level / 100) * capacity_ML;
      const new_level_ML = Math.max(0, current_level_ML + net_change_ML);
      dam_level = (new_level_ML / capacity_ML) * 100;
    }

    setData(results);
  };

  const currentRestriction = restrictionLabels[restrictionLevel];
  const finalLevel = data.length > 0 ? data[data.length - 1].dam_level : currentDamLevel;
  const daysUntilCritical = data.findIndex(d => d.dam_level <= 30);

  return (
    <div className="bg-white rounded-lg shadow-lg p-6">
      <div className="mb-6">
        <h3 className="text-xl font-bold text-gray-800 mb-2">üíß Water Restriction Impact Calculator</h3>
        <p className="text-sm text-gray-600">
          Explore how different restriction levels affect dam/reservoir levels over time. Based on real NZ water usage patterns.
        </p>
      </div>

      {/* Controls */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Restriction Level: {restrictionLevel} - {currentRestriction.name}
          </label>
          <input
            type="range"
            min="0"
            max="4"
            step="1"
            value={restrictionLevel}
            onChange={(e) => setRestrictionLevel(parseInt(e.target.value))}
            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-500"
          />
          <div className="flex justify-between text-xs text-gray-500 mt-2">
            {restrictionLabels.map(r => (
              <span key={r.level} className="text-center">L{r.level}</span>
            ))}
          </div>
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Current Dam Level: {currentDamLevel}%
          </label>
          <input
            type="range"
            min="20"
            max="90"
            value={currentDamLevel}
            onChange={(e) => setCurrentDamLevel(parseInt(e.target.value))}
            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-cyan-500"
          />
          <div className="flex justify-between text-xs text-gray-500 mt-1">
            <span>20%</span>
            <span>90%</span>
          </div>
        </div>
      </div>

      {/* Stats Cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div className="bg-blue-50 p-4 rounded-lg">
          <div className="text-sm text-gray-600">Water Usage Reduction</div>
          <div className="text-2xl font-bold text-blue-600">{currentRestriction.reduction}%</div>
          <div className="text-xs text-gray-500 mt-1">vs. unrestricted usage</div>
        </div>

        <div className="bg-cyan-50 p-4 rounded-lg">
          <div className="text-sm text-gray-600">Dam Level in 90 Days</div>
          <div className="text-2xl font-bold text-cyan-600">{finalLevel}%</div>
          <div className="text-xs text-gray-500 mt-1">projected with current restrictions</div>
        </div>

        <div className={`${daysUntilCritical > 0 && daysUntilCritical < 90 ? 'bg-red-50' : 'bg-green-50'} p-4 rounded-lg`}>
          <div className="text-sm text-gray-600">Critical Level Alert</div>
          <div className={`text-2xl font-bold ${daysUntilCritical > 0 && daysUntilCritical < 90 ? 'text-red-600' : 'text-green-600'}`}>
            {daysUntilCritical > 0 && daysUntilCritical < 90 ? `Day ${daysUntilCritical}` : 'No Alert'}
          </div>
          <div className="text-xs text-gray-500 mt-1">{daysUntilCritical > 0 && daysUntilCritical < 90 ? 'when dam hits 30%' : 'stays above 30%'}</div>
        </div>
      </div>

      {/* Chart */}
      <div className="h-80 mb-6">
        <ResponsiveContainer width="100%" height="100%">
          <LineChart data={data}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis
              dataKey="day"
              label={{ value: 'Days', position: 'insideBottom', offset: -5 }}
            />
            <YAxis
              label={{ value: 'Dam Level (%)', angle: -90, position: 'insideLeft' }}
              domain={[0, 100]}
            />
            <Tooltip
              content={({ active, payload }) => {
                if (active && payload && payload.length) {
                  const data = payload[0].payload;
                  return (
                    <div className="bg-white p-3 border border-gray-200 rounded shadow">
                      <p className="text-sm font-semibold">Day {data.day}</p>
                      <p className="text-sm">Dam Level: {data.dam_level}%</p>
                      <p className="text-sm">Usage: {data.usage} ML/day</p>
                      <p className="text-sm capitalize text-blue-600">Status: {data.status}</p>
                    </div>
                  );
                }
                return null;
              }}
            />
            <Legend />
            <ReferenceLine y={70} stroke="#10b981" strokeDasharray="3 3" label="Healthy" />
            <ReferenceLine y={50} stroke="#f59e0b" strokeDasharray="3 3" label="Watch" />
            <ReferenceLine y={30} stroke="#ef4444" strokeDasharray="3 3" label="Critical" />
            <Line
              type="monotone"
              dataKey="dam_level"
              stroke="#06b6d4"
              strokeWidth={3}
              dot={false}
              name="Dam Level %"
            />
          </LineChart>
        </ResponsiveContainer>
      </div>

      {/* Restriction Levels Guide */}
      <div className="bg-gray-50 p-4 rounded-lg mb-4">
        <h4 className="font-semibold text-sm mb-3">Restriction Levels Explained:</h4>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
          <div><strong>Level 0:</strong> No restrictions - Normal usage</div>
          <div><strong>Level 1:</strong> Voluntary conservation (10% reduction)</div>
          <div><strong>Level 2:</strong> Sprinkler ban - Hand watering only (25% reduction)</div>
          <div><strong>Level 3:</strong> Outdoor ban - No outdoor use (40% reduction)</div>
          <div><strong>Level 4:</strong> Essential only - Drinking/sanitation (55% reduction)</div>
        </div>
      </div>

      {/* Educational Note */}
      <div className="bg-purple-50 p-4 rounded-lg">
        <p className="text-sm text-gray-700">
          <strong>üí° Systems Thinking:</strong> This shows a <em>policy feedback loop</em> - restrictions reduce demand,
          which extends water supply, which delays the need for further restrictions. Notice the <em>time delay</em>:
          implementing restrictions today takes weeks to show effect on dam levels. This is a classic <em>management challenge</em>
          in resource systems - act too late and you hit crisis, act too early and you face community resistance.
        </p>
      </div>
    </div>
  );
};

export default WaterRestrictionCalculator;


================================================================================
END OF SNAPSHOT
Total Files: 37
Generated: 2025-11-21 08:57:46
================================================================================
